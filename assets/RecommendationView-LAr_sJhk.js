import{c as D,a as P,b as l,o as i,e as t,n as $,t as g,g as M,u,s as z,F as V,C as le,r as k,y as ce,z as de,O as ge,A as ue,m as O,l as Q,f as W,h as xe,x as fe}from"./index-Ckxzr6FO.js";import{u as pe}from"./recommendation-CYvUqdQH.js";import{g as ye,c as j}from"./rating-iyh53o-0.js";import{A as me}from"./arrow-left-JGhVexi9.js";import{L as be}from"./loader-2-BHTmj0By.js";import{R as ve}from"./refresh-cw-DhWnmlzn.js";/**
 * @license lucide-vue-next v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const he=D("ArrowRightIcon",[["path",{d:"M5 12h14",key:"1ays0h"}],["path",{d:"m12 5 7 7-7 7",key:"xquz4c"}]]);/**
 * @license lucide-vue-next v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ke=D("CoffeeIcon",[["path",{d:"M17 8h1a4 4 0 1 1 0 8h-1",key:"jx4kbh"}],["path",{d:"M3 8h14v9a4 4 0 0 1-4 4H7a4 4 0 0 1-4-4Z",key:"1bxrl0"}],["line",{x1:"6",x2:"6",y1:"2",y2:"4",key:"1cr9l3"}],["line",{x1:"10",x2:"10",y1:"2",y2:"4",key:"170wym"}],["line",{x1:"14",x2:"14",y1:"2",y2:"4",key:"1c5f70"}]]);/**
 * @license lucide-vue-next v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const _e=D("TargetIcon",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["circle",{cx:"12",cy:"12",r:"6",key:"1vlfrh"}],["circle",{cx:"12",cy:"12",r:"2",key:"1c9p78"}]]);/**
 * @license lucide-vue-next v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const we=D("TrendingUpIcon",[["polyline",{points:"22 7 13.5 15.5 8.5 10.5 2 17",key:"126l90"}],["polyline",{points:"16 7 22 7 22 13",key:"kwv8wd"}]]);/**
 * @license lucide-vue-next v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Se=D("ZapIcon",[["polygon",{points:"13 2 3 14 12 14 11 22 21 10 12 10 13 2",key:"45s27k"}]]),Re={class:"group relative bg-white border-2 border-black p-2 md:p-3 flex items-center gap-2 md:gap-4 transition-all duration-100 active:translate-x-1 active:translate-y-1 active:shadow-none shadow-[4px_4px_0px_0px_#000000] hover:bg-yellow-50"},Ce={class:"relative w-14 h-14 md:w-16 md:h-16 flex-shrink-0 border-2 border-black overflow-hidden bg-gray-200"},Ae=["src"],Fe={class:"flex-1 min-w-0"},$e={class:"flex items-center gap-2"},Me={class:"font-bold text-black truncate text-sm md:text-base"},De={class:"mt-1 md:mt-2 flex items-center gap-2 md:gap-4 text-xs md:text-sm"},Ne={key:0,class:"flex flex-col"},Le={key:1,class:"flex flex-col"},je={class:"font-black font-mono text-gray-800 leading-none"},ze={class:"flex flex-col"},Te={class:"text-[8px] md:text-[10px] font-bold text-gray-500 uppercase"},Ue={class:"font-black font-mono text-maimai-blue leading-none"},Be={class:"flex flex-col items-end justify-center min-w-[60px] md:min-w-[80px] pl-2 border-l-2 border-gray-100"},Ee={class:"flex items-center gap-1 text-maimai-blue font-black text-lg md:text-xl leading-none"},Oe={key:1,class:"text-[8px] md:text-[10px] text-gray-400 font-bold text-right leading-tight"},Pe={__name:"RecommendationCard",props:{song:{type:Object,required:!0},stats:{type:Object,required:!0},userRecord:{type:Object,default:null},strategy:{type:String,required:!0},targetRating:{type:Number,default:0},targetAch:{type:Number,default:0},predictedRating:{type:Number,default:0},gain:{type:Number,default:0},coverUrl:{type:String,default:""}},setup(o){const S=o,b=P(()=>{switch(S.stats.level_index){case 0:return"bg-green-500";case 1:return"bg-yellow-500";case 2:return"bg-red-500";case 3:return"bg-purple-500";case 4:return"bg-violet-300";default:return"bg-gray-500"}}),x=P(()=>["BSC","ADV","EXP","MST","Re:M"][S.stats.level_index]||"UNK"),v=r=>r>=100.5||r>=100?"text-red-500":r>=99.5||r>=99?"text-yellow-600":r>=98||r>=97?"text-orange-500":"text-gray-600",R=r=>r>=100.5?"SSS+":r>=100?"SSS":r>=99.5?"SS+":r>=99?"SS":r>=98?"S+":r>=97?"S":r.toFixed(1)+"%";return(r,y)=>(i(),l("div",Re,[t("div",Ce,[t("img",{src:o.coverUrl,class:"w-full h-full object-cover",loading:"lazy"},null,8,Ae),t("div",{class:$(["absolute bottom-0 left-0 right-0 h-1.5 border-t-2 border-black",b.value])},null,2)]),t("div",Fe,[t("div",$e,[t("span",{class:$(["text-[10px] md:text-xs font-black px-1.5 py-0.5 border border-black text-white shadow-[1px_1px_0px_0px_#000000] md:shadow-[2px_2px_0px_0px_#000000]",b.value])},g(x.value)+" "+g(o.stats.ds.toFixed(1)),3),t("h3",Me,g(o.song.title),1)]),t("div",De,[o.userRecord?(i(),l("div",Ne,[y[0]||(y[0]=t("span",{class:"text-[8px] md:text-[10px] font-bold text-gray-500 uppercase"},"Current",-1)),t("span",{class:$(["font-black font-mono leading-none",v(o.userRecord.achievements)])},g(o.userRecord.achievements.toFixed(4))+"% ",3)])):(i(),l("div",Le,[y[1]||(y[1]=t("span",{class:"text-[8px] md:text-[10px] font-bold text-gray-500 uppercase"},"Avg",-1)),t("span",je,g(o.stats.avg?o.stats.avg.toFixed(2):"---")+"% ",1)])),M(u(he),{size:14,class:"text-black flex-shrink-0","stroke-width":"3"}),t("div",ze,[t("span",Te,g(o.strategy==="attack"?"Target":"Predict"),1),t("span",Ue,g(o.strategy==="attack"?R(o.targetAch):o.stats.avg?o.stats.avg.toFixed(2)+"%":"---"),1)])])]),t("div",Be,[o.strategy!=="easy"?(i(),l(V,{key:0},[t("div",Ee,[M(u(we),{size:16,"stroke-width":"3"}),t("span",null,"+"+g(o.gain.toFixed(0)),1)]),y[2]||(y[2]=t("div",{class:"text-[8px] md:text-[10px] text-gray-400 font-bold mt-1 text-right leading-tight"}," RATING UP ",-1))],64)):z("",!0),o.stats.fit_diff?(i(),l("div",Oe," Fit: "+g(o.stats.fit_diff.toFixed(2)),1)):z("",!0)])]))}},Ve={class:"max-w-6xl mx-auto pb-12 space-y-6 px-4 md:px-0"},Ge={class:"flex items-center justify-between"},Ie={key:0,class:"bg-red-50 border-2 border-red-500 p-4 text-red-600 font-bold shadow-[4px_4px_0px_0px_#EF4444]"},qe={key:1,class:"flex flex-col items-center justify-center py-20 text-gray-500"},Ze={key:2,class:"space-y-6"},He={class:"flex overflow-x-auto gap-3 pt-2 pb-4 px-1 no-scrollbar"},Ke=["onClick"],Xe={class:"bg-white border-2 border-black p-4 md:p-6 shadow-[8px_8px_0px_0px_#000000] min-h-[400px]"},Je={key:0,class:"flex justify-end mb-4"},Qe={key:1,class:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"},We={key:2,class:"text-center text-gray-400 py-20"},Ye={key:0,class:"text-xs mt-1 text-gray-300"},ot={__name:"RecommendationView",setup(o){const S=ue(),b=le(),x=pe(),v=k("score-attack"),R=k(!0),r=k([]),y=k([]),T=k([]),G=k([]),U=k([]);ce(async()=>{R.value=!0;try{b.isAuthenticated&&b.records.length===0&&await b.fetchProfile(),r.value=await de(),await x.fetchChartStats(),Y()}catch(c){console.error(c)}finally{R.value=!1}});const Y=()=>{if(!b.records.length||!r.value.length)return;const c=b.records.map(ye),n=c.filter(e=>e.isNew).sort((e,a)=>a.ra-e.ra).slice(0,15),s=c.filter(e=>!e.isNew).sort((e,a)=>a.ra-e.ra).slice(0,35),C=n.length===15?n[14].ra:0,B=s.length===35?s[34].ra:0;n.length&&n.reduce((e,a)=>e+a.ds,0)/n.length,s.length&&s.reduce((e,a)=>e+a.ds,0)/s.length,Math.max(...c.map(e=>e.ds),10);const Z=[];c.forEach(e=>{const a=e.achievements;let f=0;if(a>=96.5&&a<97?f=97:a>=98.5&&a<99?f=99:a>=99&&a<99.5?f=99.5:a>=99.5&&a<100?f=100:a>=100&&a<100.5&&(f=100.5),f>0){const d=x.getFitDiff(e.song_id,e.level_index)||e.ds,h=j(d,f),L=e.isNew?C:B,A=e.ra>=L?e.ra:L,m=h-A;if(m>0){const p=ge(e.song_id);p&&Z.push({song:p,stats:{ds:e.ds,fit_diff:d,level_index:e.level_index,avg:x.getAvgAchievement(e.song_id,e.level_index)},userRecord:e,targetRating:h,targetAch:f,gain:m,strategy:"attack"})}}}),y.value=Z.sort((e,a)=>a.gain-e.gain).slice(0,50);const H=[],K=[],te=new Set(c.map(e=>`${e.song_id}_${e.level_index}`)),E=[...n,...s],se=E.length?E.reduce((e,a)=>e+a.ds,0)/E.length:10,N=Math.round(se*10)/10,ae=parseFloat((N-.6).toFixed(1)),ne=parseFloat((N+.6).toFixed(1)),re=parseFloat(Math.max(1,N-1.5).toFixed(1)),oe=parseFloat(Math.max(1,N-.5).toFixed(1));r.value.forEach(e=>{if(!e.basic_info)return;const f=!!e.basic_info.is_new?C:B;e.ds.forEach((d,h)=>{const L=`${e.id}_${h}`,A=te.has(L),m=x.getFitDiff(e.id,h)||d,p=x.getAvgAchievement(e.id,h),X={ds:d,fit_diff:m,level_index:h,avg:p};if(!A&&p&&d>=ae&&d<=ne){const _=m<d,w=p>=99;if(_||w){const F=j(m,p),J=F-f;if(J>0){const ie={song:e,stats:X,predictedRating:F,gain:J,strategy:"gem"};H.push(ie)}}}if(p&&d>=re&&d<=oe&&m<=d+.2&&p>=98&&parseInt(e.id)<1e5){let _=0;if(A){const w=c.find(F=>F.song_id===e.id&&F.level_index===h);_=w?w.achievements:0}if(_<100.5){const w=j(m,100.5);K.push({song:e,stats:X,userRecord:A?{achievements:_,ra:j(m,_)}:null,predictedRating:w,gain:p,strategy:"easy"})}}})}),U.value=H.sort((e,a)=>a.gain-e.gain),I(),G.value=K.sort((e,a)=>a.stats.avg-e.stats.avg).slice(0,50)},I=()=>{if(U.value.length===0){T.value=[];return}const c=[...U.value].sort(()=>.5-Math.random());T.value=c.slice(0,20).sort((n,s)=>s.gain-n.gain)},q=P(()=>{switch(v.value){case"score-attack":return y.value;case"old-gem":return T.value;case"easy":return G.value;default:return[]}}),ee=[{id:"score-attack",label:"临门一脚",icon:_e,color:"text-red-500"},{id:"old-gem",label:"旧曲挖掘",icon:Se,color:"text-blue-500"},{id:"easy",label:"甜品推荐",icon:ke,color:"text-green-500"}];return(c,n)=>(i(),l("div",Ve,[t("div",Ge,[t("button",{onClick:n[0]||(n[0]=s=>u(S).back()),class:"flex items-center gap-1 text-gray-500 font-bold hover:text-black transition-colors"},[M(u(me),{size:20}),n[1]||(n[1]=O(" 返回 ",-1))]),n[2]||(n[2]=t("h1",{class:"text-2xl font-black text-gray-800"},"推分建议",-1)),n[3]||(n[3]=t("div",{class:"w-20"},null,-1))]),u(x).error?(i(),l("div",Ie," 数据加载失败: "+g(u(x).error),1)):R.value||u(x).isLoading?(i(),l("div",qe,[M(u(be),{class:"animate-spin mb-2",size:32}),n[4]||(n[4]=t("p",null,"正在分析全服数据...",-1))])):(i(),l("div",Ze,[t("div",He,[(i(),l(V,null,Q(ee,s=>t("button",{key:s.id,onClick:C=>v.value=s.id,class:$(["flex items-center gap-2 px-6 py-3 font-black transition-all whitespace-nowrap border-2",v.value===s.id?"bg-white border-black shadow-[4px_4px_0px_0px_#000000] -translate-y-1":"bg-gray-100 border-transparent text-gray-400 hover:border-black hover:bg-white hover:text-black"])},[(i(),W(xe(s.icon),{size:18,class:$(v.value===s.id?s.color:"")},null,8,["class"])),O(" "+g(s.label),1)],10,Ke)),64))]),t("div",Xe,[v.value==="old-gem"?(i(),l("div",Je,[t("button",{onClick:I,class:"flex items-center gap-2 px-4 py-2 bg-blue-50 text-blue-600 font-bold border-2 border-blue-200 hover:border-blue-500 hover:bg-blue-100 transition-colors"},[M(u(ve),{size:16}),n[5]||(n[5]=O(" 换一批 ",-1))])])):z("",!0),q.value.length>0?(i(),l("div",Qe,[(i(!0),l(V,null,Q(q.value,(s,C)=>(i(),W(Pe,{key:C,song:s.song,stats:s.stats,"user-record":s.userRecord,strategy:s.strategy,"target-rating":s.targetRating,"target-ach":s.targetAch,"predicted-rating":s.predictedRating,gain:s.gain,"cover-url":u(fe)(s.song.id),onClick:B=>u(S).push(`/song/${s.song.id}`),class:"cursor-pointer"},null,8,["song","stats","user-record","strategy","target-rating","target-ach","predicted-rating","gain","cover-url","onClick"]))),128))])):(i(),l("div",We,[n[6]||(n[6]=t("p",{class:"font-bold text-lg"},"暂无推荐",-1)),n[7]||(n[7]=t("p",{class:"text-sm mt-2"},"可能是数据不足或您太强了！",-1)),v.value!=="score-attack"?(i(),l("p",Ye," (挖掘功能需要加载 chart_stats.json 数据) ")):z("",!0)]))])]))]))}};export{ot as default};
