import{d as V,C as P,r as R,a as c,x as z,b as u,o as l,e,s as $,n as j,t as d,J as M,y as X,z as O,u as F,A as W,g as N,m as U,f as D,T as q,F as E,l as G}from"./index-BVpVXXB2.js";import{u as J}from"./recommendation-C8Od98en.js";import{c as Y}from"./rating-aTCu6OCO.js";import{D as H,t as K}from"./index-D_W1WrYU.js";import{A as Q}from"./arrow-left-jOfwdKCj.js";import{L as Z}from"./loader-2-yR3RaBWB.js";import{I as ee}from"./info-6YPMLYN5.js";const te=V("fitting",()=>{const n=P(),a=J(),b=R([]),f=R({sd:[],dx:[]}),h=R(0),m=R(!1);return{fittingRecords:b,fittingB50:f,fittingRating:h,isCalculated:m,calculate:async()=>{if(n.records.length===0&&!await n.fetchProfile()&&n.records.length===0)return;Object.keys(a.chartStats).length===0&&await a.fetchChartStats();const I=n.records,p=a.chartStats,_=I.map(r=>{const v=r.song_id,A=r.level_index;let T=r.ds,s=!1;if(p[v]&&p[v][A]){const o=p[v][A];o.fit_diff!==void 0&&o.fit_diff!==null&&(T=o.fit_diff,s=!0)}const t=Y(T,r.achievements);return{...r,fit_diff:T,is_fit:s,ra:t}});_.sort((r,v)=>v.ra-r.ra);const w=_.filter(r=>r.type==="SD"),k=_.filter(r=>r.type==="DX"),g=w.slice(0,35),i=k.slice(0,15);f.value={sd:g,dx:i};const y=[...g,...i].reduce((r,v)=>r+v.ra,0);h.value=y,b.value=_,m.value=!0}}}),se={class:"relative bg-white border-2 border-black flex flex-col select-none h-full shadow-[4px_4px_0px_0px_#000000] hover:translate-x-[2px] hover:translate-y-[2px] hover:shadow-[2px_2px_0px_0px_#000000] transition-all"},oe={class:"relative z-10 flex flex-col h-full"},ae={class:"relative aspect-[1.7/1] overflow-hidden border-b-2 border-black"},re=["src"],le={key:0,class:"absolute top-0 left-0 bg-black text-white px-1.5 py-0.5 text-[10px] font-bold border-r-2 border-b-2 border-white"},ie={class:"absolute bottom-0 left-0 flex items-stretch"},ne={class:"bg-black text-white px-2 py-0.5 text-xs font-bold border-t-2 border-r-2 border-white ml-[-2px] pl-3 flex items-center"},ce={class:"p-2 flex flex-col gap-1 flex-1 justify-between bg-white"},de=["title"],xe={class:"flex items-center gap-1 text-[10px] leading-none mt-0.5"},ue={key:0,class:"text-[8px] text-gray-400 line-through"},pe={class:"flex items-end justify-between mt-1"},fe={class:"flex items-center gap-0.5 h-4 md:h-5"},me=["src"],be=["src"],_e=["src"],L={__name:"FittingB50SongCard",props:{record:{type:Object,required:!0},rank:{type:Number,default:0},customCoverUrl:{type:String,default:""}},setup(n){const a=n,b=c(()=>["bg-maimai-green","bg-maimai-yellow","bg-maimai-red","bg-maimai-purple","bg-pink-300"][a.record.level_index]||"bg-gray-400"),f=c(()=>{if(a.customCoverUrl)return a.customCoverUrl;const i=z(a.record.song_id);try{return new URL(i,window.location.origin).href}catch{return i}}),h=c(()=>a.record.achievements.toFixed(4)+"%"),m=c(()=>{const i=a.record.rate.toLowerCase();return i.startsWith("ss")?"text-[#FFD700]":i.startsWith("s")?"text-[#FF4500]":"text-blue-500"}),S=c(()=>a.record.type==="DX"?"bg-blue-500":"bg-yellow-500"),I=c(()=>`/maiFCFS/${a.record.rate.toLowerCase().replace("+","p")}.png`),p=c(()=>a.record.fc?`/maiFCFS/${a.record.fc}.png`:null),_=c(()=>a.record.fs?`/maiFCFS/${a.record.fs}.png`:null),w=i=>{i.target.src="/default_cover.jpg"},k=c(()=>a.record.fit_diff?a.record.fit_diff.toFixed(1):a.record.ds.toFixed(1)),g=c(()=>a.record.is_fit);return(i,y)=>(l(),u("div",se,[e("div",oe,[e("div",ae,[e("img",{src:f.value,onError:w,class:"w-full h-full object-cover"},null,40,re),e("div",{class:j([S.value,"absolute top-0 right-0 px-1.5 py-0.5 text-[10px] font-black text-white border-l-2 border-b-2 border-black"])},d(n.record.type),3),n.rank>0?(l(),u("div",le," #"+d(n.rank),1)):$("",!0),e("div",ie,[e("div",{class:j([b.value,"relative z-10 px-2 py-0.5 text-white text-xs font-black border-t-2 border-r-2 border-black flex items-center justify-center min-w-[2rem]"])},d(n.record.level),3),e("div",ne,d(n.record.ra),1)])]),e("div",ce,[e("div",{class:"text-[10px] font-bold leading-tight line-clamp-1 text-black",title:n.record.title},d(n.record.title),9,de),e("div",xe,[y[0]||(y[0]=e("span",{class:"font-bold text-gray-500"},"DS:",-1)),e("span",{class:j(g.value?"text-maimai-pink font-black":"text-black")},d(k.value),3),g.value?(l(),u("span",ue,d(n.record.ds.toFixed(1)),1)):$("",!0)]),e("div",pe,[e("span",{class:j([m.value,"text-sm md:text-lg font-black italic tracking-tighter"])},d(h.value),3),e("div",fe,[e("img",{src:I.value,class:"h-full object-contain"},null,8,me),p.value?(l(),u("img",{key:0,src:p.value,class:"h-full object-contain"},null,8,be)):$("",!0),_.value?(l(),u("img",{key:1,src:_.value,class:"h-full object-contain"},null,8,_e)):$("",!0)])])])])]))}},ge={class:"max-w-6xl mx-auto pb-12 space-y-6"},ve={class:"flex items-center justify-between px-4 md:px-0"},he={class:"flex gap-4"},we=["disabled"],ke={class:"flex justify-between items-center px-4 md:px-0"},ye={class:"flex items-center gap-2 text-sm text-gray-600 bg-white px-3 py-1 border border-gray-300 rounded-lg"},Re={class:"flex flex-col md:flex-row items-center justify-between mb-8 gap-6 bg-[#FFFBEB] p-4 md:p-6 border-2 border-black shadow-[4px_4px_0px_0px_#000000] rounded-3xl"},Ce={class:"flex flex-col md:flex-row items-center gap-4 md:gap-6 w-full md:w-auto"},Fe={class:"w-20 h-20 md:w-24 md:h-24 bg-maimai-pink border-2 border-black flex items-center justify-center shadow-[4px_4px_0px_0px_#000000] flex-shrink-0"},$e={class:"flex flex-col items-center md:items-start w-full"},Se={class:"text-2xl md:text-3xl font-black text-black uppercase tracking-tighter mb-2 text-center md:text-left truncate max-w-[240px] md:max-w-xs"},Ie={class:"relative w-full max-w-[260px] md:max-w-[320px] select-none filter drop-shadow-md",style:{"aspect-ratio":"1430/308"}},Te=["src"],je={class:"absolute top-0 bottom-0 flex",style:{left:"46.8%",width:"40.5%"}},Ae={class:"flex gap-3 md:gap-4 text-center w-full md:w-auto justify-center"},De={class:"bg-white px-4 md:px-5 py-2 md:py-3 border-2 border-black shadow-[4px_4px_0px_0px_#000000] rounded-xl flex-1 md:flex-none min-w-[100px]"},Be={class:"text-xl md:text-2xl font-black text-black leading-none"},Ne={class:"bg-white px-4 md:px-5 py-2 md:py-3 border-2 border-black shadow-[4px_4px_0px_0px_#000000] rounded-xl flex-1 md:flex-none min-w-[100px]"},Ue={class:"text-xl md:text-2xl font-black text-black leading-none"},Ee={class:"space-y-10"},Ge={key:0},Le={class:"flex items-center gap-3 mb-6"},Pe={class:"font-black text-black border-2 border-black px-2 py-0.5 bg-white shadow-[2px_2px_0px_0px_#000000]"},ze={class:"grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-3 md:gap-4"},Ve={key:1},Me={class:"flex items-center gap-3 mb-6"},Xe={class:"font-black text-black border-2 border-black px-2 py-0.5 bg-white shadow-[2px_2px_0px_0px_#000000]"},Oe={class:"grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-3 md:gap-4"},Ze={__name:"FittingB50View",setup(n){const a=W(),b=P(),f=te(),h=R(null),m=R(!1),S=R(!1),I=R(!1),p=M({}),_=async()=>{if(confirm("确定要重新获取最新成绩并重新计算拟合B50吗？")){S.value=!0;try{await b.fetchProfile(),await f.calculate()}catch(s){alert("更新失败: "+s.message)}finally{S.value=!1}}},w=c(()=>f.fittingB50.sd),k=c(()=>f.fittingB50.dx),g=c(()=>f.fittingRating),i=c(()=>w.value.reduce((s,t)=>s+t.ra,0)),y=c(()=>k.value.reduce((s,t)=>s+t.ra,0)),r=s=>{a.push(`/song/${s.song_id}`)},v=async()=>{const s=[...k.value,...w.value].map(async t=>{if(p[t.song_id])return;const o=async x=>{const C=await fetch(x);if(!C.ok)throw new Error(`Failed to load ${x}`);return await C.blob()};try{let x;try{x=await o(z(t.song_id))}catch{x=await o("/default_cover.jpg")}return new Promise(C=>{const B=new FileReader;B.onloadend=()=>{p[t.song_id]=B.result,C()},B.readAsDataURL(x)})}catch(x){console.error("Failed to preload image for",t.song_id,x)}});await Promise.all(s)},A=async()=>{if(h.value){m.value=!0;try{await v(),await new Promise(o=>setTimeout(o,1e3));const s=await K(h.value,{cacheBust:!1,pixelRatio:2,backgroundColor:"#f3f4f6",skipAutoScale:!0,fontEmbedCSS:""}),t=document.createElement("a");t.download=`maimai_fitting_b50_${b.profile.username||"user"}.png`,t.href=s,t.click()}catch(s){console.error("Export failed:",s),alert("图片生成失败，请重试")}finally{m.value=!1}}};X(async()=>{try{await O(),I.value=!0}catch(s){console.error("Failed to load music data",s)}b.isAuthenticated&&await f.calculate()});const T=s=>s>=15e3?"/maiRATING/11.png":s>=14500?"/maiRATING/10.png":s>=14e3?"/maiRATING/9.png":s>=13e3?"/maiRATING/8.png":s>=12e3?"/maiRATING/7.png":s>=1e4?"/maiRATING/6.png":s>=7e3?"/maiRATING/5.png":s>=4e3?"/maiRATING/4.png":s>=2e3?"/maiRATING/3.png":s>=1e3?"/maiRATING/2.png":"/maiRATING/1.png";return(s,t)=>(l(),u("div",ge,[e("div",ve,[e("button",{onClick:t[0]||(t[0]=o=>F(a).back()),class:"flex items-center gap-1 text-gray-500 font-bold hover:text-black transition-colors"},[N(F(Q),{size:20}),t[1]||(t[1]=U(" 返回 ",-1))]),e("div",he,[e("button",{onClick:A,disabled:m.value,class:"flex items-center gap-2 px-4 py-2 text-sm font-bold bg-maimai-blue text-white border-2 border-black shadow-[4px_4px_0px_0px_#000000] hover:translate-x-[2px] hover:translate-y-[2px] hover:shadow-[2px_2px_0px_0px_#000000] active:translate-x-[4px] active:translate-y-[4px] active:shadow-none transition-all disabled:opacity-50 disabled:cursor-not-allowed"},[m.value?(l(),D(F(Z),{key:0,class:"animate-spin",size:18})):(l(),D(F(H),{key:1,size:18})),U(" "+d(m.value?"生成中...":"保存图片"),1)],8,we)])]),e("div",ke,[e("div",ye,[N(F(ee),{size:16}),t[2]||(t[2]=e("span",null,"基于拟合定数计算，仅供参考",-1))]),e("button",{onClick:_,class:"text-xs font-bold text-gray-400 underline hover:text-maimai-blue"}," 数据不准确？点击更新成绩 ")]),e("div",{ref_key:"exportRef",ref:h,class:"bg-white p-4 md:p-8 border-2 border-black shadow-[8px_8px_0px_0px_#000000]"},[e("div",Re,[e("div",Ce,[e("div",Fe,[N(F(q),{size:40,class:"text-black md:w-12 md:h-12","stroke-width":"2.5"})]),e("div",$e,[e("h1",Se,[U(d(F(b).profile.nickname||"PLAYER")+" ",1),t[3]||(t[3]=e("span",{class:"text-sm md:text-base text-maimai-pink ml-2"},"(拟合)",-1))]),e("div",Ie,[e("img",{src:T(g.value),class:"w-full h-full object-contain block",alt:"DX Rating Plate"},null,8,Te),e("div",je,[(l(!0),u(E,null,G(g.value.toString().padStart(5," ").split(""),(o,x)=>(l(),u("div",{key:x,class:"w-full h-full flex items-center justify-center"},[o!==" "?(l(),u("span",{key:0,class:j(["font-black text-white font-mono leading-none text-center",g.value>=1e4?"text-lg md:text-xl":"text-xl md:text-2xl"]),style:{"text-shadow":"1.5px 1.5px 0 #000"}},d(o),3)):$("",!0)]))),128))])])])]),e("div",Ae,[e("div",De,[t[4]||(t[4]=e("div",{class:"text-[10px] md:text-xs font-black text-blue-500 uppercase tracking-wider mb-1"},"Best 35",-1)),e("div",Be,d(i.value),1)]),e("div",Ne,[t[5]||(t[5]=e("div",{class:"text-[10px] md:text-xs font-black text-yellow-500 uppercase tracking-wider mb-1"},"Best 15",-1)),e("div",Ue,d(y.value),1)])])]),e("div",Ee,[w.value.length>0?(l(),u("div",Ge,[e("div",Le,[t[6]||(t[6]=e("div",{class:"bg-maimai-blue text-white px-4 py-1 font-black text-xl border-2 border-black shadow-[4px_4px_0px_0px_#000000] uppercase italic transform -skew-x-12"}," Past Versions ",-1)),t[7]||(t[7]=e("div",{class:"h-1 flex-1 bg-black"},null,-1)),e("span",Pe,"Total: "+d(i.value),1)]),e("div",ze,[(l(!0),u(E,null,G(w.value,(o,x)=>(l(),D(L,{key:o.song_id+"_"+o.level_index,record:o,rank:x+1,"custom-cover-url":p[o.song_id],class:"cursor-pointer",onClick:C=>r(o)},null,8,["record","rank","custom-cover-url","onClick"]))),128))])])):$("",!0),k.value.length>0?(l(),u("div",Ve,[e("div",Me,[t[8]||(t[8]=e("div",{class:"bg-maimai-yellow text-black px-4 py-1 font-black text-xl border-2 border-black shadow-[4px_4px_0px_0px_#000000] uppercase italic transform -skew-x-12"}," Current Version ",-1)),t[9]||(t[9]=e("div",{class:"h-1 flex-1 bg-black"},null,-1)),e("span",Xe,"Total: "+d(y.value),1)]),e("div",Oe,[(l(!0),u(E,null,G(k.value,(o,x)=>(l(),D(L,{key:o.song_id+"_"+o.level_index,record:o,rank:x+1,"custom-cover-url":p[o.song_id],class:"cursor-pointer",onClick:C=>r(o)},null,8,["record","rank","custom-cover-url","onClick"]))),128))])])):$("",!0)])],512)]))}};export{Ze as default};
