import{d as O,C as V,r as R,z,a as c,x as M,b as u,o as i,e,s as F,n as A,t as d,J as W,y as X,u as C,A as q,g as U,m as E,f as B,T as J,F as G,l as P}from"./index-Ckxzr6FO.js";import{u as Y}from"./recommendation-CYvUqdQH.js";import{c as H}from"./rating-iyh53o-0.js";import{D as K,t as Q}from"./index-TLWY2T1E.js";import{A as Z}from"./arrow-left-JGhVexi9.js";import{L as ee}from"./loader-2-BHTmj0By.js";import{I as te}from"./info-BPO-05x5.js";const se=O("fitting",()=>{const n=V(),a=Y(),g=R([]),f=R({sd:[],dx:[]}),k=R(0),m=R(!1);return{fittingRecords:g,fittingB50:f,fittingRating:k,isCalculated:m,calculate:async()=>{if(n.records.length===0&&!await n.fetchProfile()&&n.records.length===0)return;Object.keys(a.chartStats).length===0&&await a.fetchChartStats();const T=await z(),v=new Map(T.map(r=>[r.id,r])),$=n.records,b=a.chartStats,p=$.map(r=>{var S;const _=r.song_id,s=r.level_index,t=v.get(String(_));let o=r.ds,l=!1;if(b[_]&&b[_][s]){const N=b[_][s];N.fit_diff!==void 0&&N.fit_diff!==null&&(o=N.fit_diff,l=!0)}const w=H(o,r.achievements);return{...r,fit_diff:o,is_fit:l,ra:w,is_new:((S=t==null?void 0:t.basic_info)==null?void 0:S.is_new)||!1}});p.sort((r,_)=>_.ra-r.ra);const y=p.filter(r=>r.is_new),h=p.filter(r=>!r.is_new).slice(0,35),j=y.slice(0,15);f.value={sd:h,dx:j};const D=[...h,...j].reduce((r,_)=>r+_.ra,0);k.value=D,g.value=p,m.value=!0}}}),oe={class:"relative bg-white border-2 border-black flex flex-col select-none h-full shadow-[4px_4px_0px_0px_#000000] hover:translate-x-[2px] hover:translate-y-[2px] hover:shadow-[2px_2px_0px_0px_#000000] transition-all"},ae={class:"relative z-10 flex flex-col h-full"},re={class:"relative aspect-[1.7/1] overflow-hidden border-b-2 border-black"},le=["src"],ie={key:0,class:"absolute top-0 left-0 bg-black text-white px-1.5 py-0.5 text-[10px] font-bold border-r-2 border-b-2 border-white"},ne={class:"absolute bottom-0 left-0 flex items-stretch"},ce={class:"bg-black text-white px-2 py-0.5 text-xs font-bold border-t-2 border-r-2 border-white ml-[-2px] pl-3 flex items-center"},de={class:"p-2 flex flex-col gap-1 flex-1 justify-between bg-white"},xe=["title"],ue={class:"flex items-center gap-1 text-[10px] leading-none mt-0.5"},pe={key:0,class:"text-[8px] text-gray-400 line-through"},fe={class:"flex items-end justify-between mt-1"},me={class:"flex items-center gap-0.5 h-4 md:h-5"},be=["src"],_e=["src"],ge=["src"],L={__name:"FittingB50SongCard",props:{record:{type:Object,required:!0},rank:{type:Number,default:0},customCoverUrl:{type:String,default:""}},setup(n){const a=n,g=c(()=>["bg-maimai-green","bg-maimai-yellow","bg-maimai-red","bg-maimai-purple","bg-pink-300"][a.record.level_index]||"bg-gray-400"),f=c(()=>{if(a.customCoverUrl)return a.customCoverUrl;const x=M(a.record.song_id);try{return new URL(x,window.location.origin).href}catch{return x}}),k=c(()=>a.record.achievements.toFixed(4)+"%"),m=c(()=>{const x=a.record.rate.toLowerCase();return x.startsWith("ss")?"text-[#FFD700]":x.startsWith("s")?"text-[#FF4500]":"text-blue-500"}),I=c(()=>a.record.type==="DX"?"bg-blue-500":"bg-yellow-500"),T=c(()=>`/maiFCFS/${a.record.rate.toLowerCase().replace("+","p")}.png`),v=c(()=>a.record.fc?`/maiFCFS/${a.record.fc}.png`:null),$=c(()=>a.record.fs?`/maiFCFS/${a.record.fs}.png`:null),b=x=>{x.target.src="/default_cover.jpg"},p=c(()=>a.record.fit_diff?a.record.fit_diff.toFixed(1):a.record.ds.toFixed(1)),y=c(()=>a.record.is_fit);return(x,h)=>(i(),u("div",oe,[e("div",ae,[e("div",re,[e("img",{src:f.value,onError:b,class:"w-full h-full object-cover"},null,40,le),e("div",{class:A([I.value,"absolute top-0 right-0 px-1.5 py-0.5 text-[10px] font-black text-white border-l-2 border-b-2 border-black"])},d(n.record.type),3),n.rank>0?(i(),u("div",ie," #"+d(n.rank),1)):F("",!0),e("div",ne,[e("div",{class:A([g.value,"relative z-10 px-2 py-0.5 text-white text-xs font-black border-t-2 border-r-2 border-black flex items-center justify-center min-w-[2rem]"])},d(n.record.level),3),e("div",ce,d(n.record.ra),1)])]),e("div",de,[e("div",{class:"text-[10px] font-bold leading-tight line-clamp-1 text-black",title:n.record.title},d(n.record.title),9,xe),e("div",ue,[h[0]||(h[0]=e("span",{class:"font-bold text-gray-500"},"DS:",-1)),e("span",{class:A(y.value?"text-maimai-pink font-black":"text-black")},d(p.value),3),y.value?(i(),u("span",pe,d(n.record.ds.toFixed(1)),1)):F("",!0)]),e("div",fe,[e("span",{class:A([m.value,"text-sm md:text-lg font-black italic tracking-tighter"])},d(k.value),3),e("div",me,[e("img",{src:T.value,class:"h-full object-contain"},null,8,be),v.value?(i(),u("img",{key:0,src:v.value,class:"h-full object-contain"},null,8,_e)):F("",!0),$.value?(i(),u("img",{key:1,src:$.value,class:"h-full object-contain"},null,8,ge)):F("",!0)])])])])]))}},ve={class:"max-w-6xl mx-auto pb-12 space-y-6"},he={class:"flex items-center justify-between px-4 md:px-0"},we={class:"flex gap-4"},ke=["disabled"],ye={class:"flex justify-between items-center px-4 md:px-0"},Re={class:"flex items-center gap-2 text-sm text-gray-600 bg-white px-3 py-1 border border-gray-300 rounded-lg"},Ce={class:"flex flex-col md:flex-row items-center justify-between mb-8 gap-6 bg-[#FFFBEB] p-4 md:p-6 border-2 border-black shadow-[4px_4px_0px_0px_#000000] rounded-3xl"},Fe={class:"flex flex-col md:flex-row items-center gap-4 md:gap-6 w-full md:w-auto"},$e={class:"w-20 h-20 md:w-24 md:h-24 bg-maimai-pink border-2 border-black flex items-center justify-center shadow-[4px_4px_0px_0px_#000000] flex-shrink-0"},Se={class:"flex flex-col items-center md:items-start w-full"},Ie={class:"text-2xl md:text-3xl font-black text-black uppercase tracking-tighter mb-2 text-center md:text-left truncate max-w-[240px] md:max-w-xs"},Te={class:"relative w-full max-w-[260px] md:max-w-[320px] select-none filter drop-shadow-md",style:{"aspect-ratio":"1430/308"}},je=["src"],Ae={class:"absolute top-0 bottom-0 flex",style:{left:"46.8%",width:"40.5%"}},Be={class:"flex gap-3 md:gap-4 text-center w-full md:w-auto justify-center"},De={class:"bg-white px-4 md:px-5 py-2 md:py-3 border-2 border-black shadow-[4px_4px_0px_0px_#000000] rounded-xl flex-1 md:flex-none min-w-[100px]"},Ne={class:"text-xl md:text-2xl font-black text-black leading-none"},Ue={class:"bg-white px-4 md:px-5 py-2 md:py-3 border-2 border-black shadow-[4px_4px_0px_0px_#000000] rounded-xl flex-1 md:flex-none min-w-[100px]"},Ee={class:"text-xl md:text-2xl font-black text-black leading-none"},Ge={class:"space-y-10"},Pe={key:0},Le={class:"flex items-center gap-3 mb-6"},Ve={class:"font-black text-black border-2 border-black px-2 py-0.5 bg-white shadow-[2px_2px_0px_0px_#000000]"},ze={class:"grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-3 md:gap-4"},Me={key:1},Oe={class:"flex items-center gap-3 mb-6"},We={class:"font-black text-black border-2 border-black px-2 py-0.5 bg-white shadow-[2px_2px_0px_0px_#000000]"},Xe={class:"grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-3 md:gap-4"},et={__name:"FittingB50View",setup(n){const a=q(),g=V(),f=se(),k=R(null),m=R(!1),I=R(!1),T=R(!1),v=W({}),$=async()=>{if(confirm("确定要重新获取最新成绩并重新计算拟合B50吗？")){I.value=!0;try{await g.fetchProfile(),await f.calculate()}catch(s){alert("更新失败: "+s.message)}finally{I.value=!1}}},b=c(()=>f.fittingB50.sd),p=c(()=>f.fittingB50.dx),y=c(()=>f.fittingRating),x=c(()=>b.value.reduce((s,t)=>s+t.ra,0)),h=c(()=>p.value.reduce((s,t)=>s+t.ra,0)),j=s=>{a.push(`/song/${s.song_id}`)},D=async()=>{const s=[...p.value,...b.value].map(async t=>{if(v[t.song_id])return;const o=async l=>{const w=await fetch(l);if(!w.ok)throw new Error(`Failed to load ${l}`);return await w.blob()};try{let l;try{l=await o(M(t.song_id))}catch{l=await o("/default_cover.jpg")}return new Promise(w=>{const S=new FileReader;S.onloadend=()=>{v[t.song_id]=S.result,w()},S.readAsDataURL(l)})}catch(l){console.error("Failed to preload image for",t.song_id,l)}});await Promise.all(s)},r=async()=>{if(k.value){m.value=!0;try{await D(),await new Promise(o=>setTimeout(o,1e3));const s=await Q(k.value,{cacheBust:!1,pixelRatio:2,backgroundColor:"#f3f4f6",skipAutoScale:!0,fontEmbedCSS:""}),t=document.createElement("a");t.download=`maimai_fitting_b50_${g.profile.username||"user"}.png`,t.href=s,t.click()}catch(s){console.error("Export failed:",s),alert("图片生成失败，请重试")}finally{m.value=!1}}};X(async()=>{try{await z(),T.value=!0}catch(s){console.error("Failed to load music data",s)}g.isAuthenticated&&await f.calculate()});const _=s=>s>=15e3?"/maiRATING/11.png":s>=14500?"/maiRATING/10.png":s>=14e3?"/maiRATING/9.png":s>=13e3?"/maiRATING/8.png":s>=12e3?"/maiRATING/7.png":s>=1e4?"/maiRATING/6.png":s>=7e3?"/maiRATING/5.png":s>=4e3?"/maiRATING/4.png":s>=2e3?"/maiRATING/3.png":s>=1e3?"/maiRATING/2.png":"/maiRATING/1.png";return(s,t)=>(i(),u("div",ve,[e("div",he,[e("button",{onClick:t[0]||(t[0]=o=>C(a).back()),class:"flex items-center gap-1 text-gray-500 font-bold hover:text-black transition-colors"},[U(C(Z),{size:20}),t[1]||(t[1]=E(" 返回 ",-1))]),e("div",we,[e("button",{onClick:r,disabled:m.value,class:"flex items-center gap-2 px-4 py-2 text-sm font-bold bg-maimai-blue text-white border-2 border-black shadow-[4px_4px_0px_0px_#000000] hover:translate-x-[2px] hover:translate-y-[2px] hover:shadow-[2px_2px_0px_0px_#000000] active:translate-x-[4px] active:translate-y-[4px] active:shadow-none transition-all disabled:opacity-50 disabled:cursor-not-allowed"},[m.value?(i(),B(C(ee),{key:0,class:"animate-spin",size:18})):(i(),B(C(K),{key:1,size:18})),E(" "+d(m.value?"生成中...":"保存图片"),1)],8,ke)])]),e("div",ye,[e("div",Re,[U(C(te),{size:16}),t[2]||(t[2]=e("span",null,"基于拟合定数计算，仅供参考",-1))]),e("button",{onClick:$,class:"text-xs font-bold text-gray-400 underline hover:text-maimai-blue"}," 数据不准确？点击更新成绩 ")]),e("div",{ref_key:"exportRef",ref:k,class:"bg-white p-4 md:p-8 border-2 border-black shadow-[8px_8px_0px_0px_#000000]"},[e("div",Ce,[e("div",Fe,[e("div",$e,[U(C(J),{size:40,class:"text-black md:w-12 md:h-12","stroke-width":"2.5"})]),e("div",Se,[e("h1",Ie,[E(d(C(g).profile.nickname||"PLAYER")+" ",1),t[3]||(t[3]=e("span",{class:"text-sm md:text-base text-maimai-pink ml-2"},"(拟合)",-1))]),e("div",Te,[e("img",{src:_(y.value),class:"w-full h-full object-contain block",alt:"DX Rating Plate"},null,8,je),e("div",Ae,[(i(!0),u(G,null,P(y.value.toString().padStart(5," ").split(""),(o,l)=>(i(),u("div",{key:l,class:"w-full h-full flex items-center justify-center"},[o!==" "?(i(),u("span",{key:0,class:A(["font-black text-white font-mono leading-none text-center",y.value>=1e4?"text-lg md:text-xl":"text-xl md:text-2xl"]),style:{"text-shadow":"1.5px 1.5px 0 #000"}},d(o),3)):F("",!0)]))),128))])])])]),e("div",Be,[e("div",De,[t[4]||(t[4]=e("div",{class:"text-[10px] md:text-xs font-black text-blue-500 uppercase tracking-wider mb-1"},"Best 35",-1)),e("div",Ne,d(x.value),1)]),e("div",Ue,[t[5]||(t[5]=e("div",{class:"text-[10px] md:text-xs font-black text-yellow-500 uppercase tracking-wider mb-1"},"Best 15",-1)),e("div",Ee,d(h.value),1)])])]),e("div",Ge,[b.value.length>0?(i(),u("div",Pe,[e("div",Le,[t[6]||(t[6]=e("div",{class:"bg-maimai-blue text-white px-4 py-1 font-black text-xl border-2 border-black shadow-[4px_4px_0px_0px_#000000] uppercase italic transform -skew-x-12"}," Past Versions ",-1)),t[7]||(t[7]=e("div",{class:"h-1 flex-1 bg-black"},null,-1)),e("span",Ve,"Total: "+d(x.value),1)]),e("div",ze,[(i(!0),u(G,null,P(b.value,(o,l)=>(i(),B(L,{key:o.song_id+"_"+o.level_index,record:o,rank:l+1,"custom-cover-url":v[o.song_id],class:"cursor-pointer",onClick:w=>j(o)},null,8,["record","rank","custom-cover-url","onClick"]))),128))])])):F("",!0),p.value.length>0?(i(),u("div",Me,[e("div",Oe,[t[8]||(t[8]=e("div",{class:"bg-maimai-yellow text-black px-4 py-1 font-black text-xl border-2 border-black shadow-[4px_4px_0px_0px_#000000] uppercase italic transform -skew-x-12"}," Current Version ",-1)),t[9]||(t[9]=e("div",{class:"h-1 flex-1 bg-black"},null,-1)),e("span",We,"Total: "+d(h.value),1)]),e("div",Xe,[(i(!0),u(G,null,P(p.value,(o,l)=>(i(),B(L,{key:o.song_id+"_"+o.level_index,record:o,rank:l+1,"custom-cover-url":v[o.song_id],class:"cursor-pointer",onClick:w=>j(o)},null,8,["record","rank","custom-cover-url","onClick"]))),128))])])):F("",!0)])],512)]))}};export{et as default};
