import{b as V,k as ne,d as r,o,e as s,n as B,t as d,F as y,i as h,j as O,u as ie,a as n,l as ue,x as de,m as ce,w as ve,f as S,g as Z,h as f,M as pe,p,v as L,s as ee,X as be,q,C as fe,y as ge}from"./index-DDtBvkLk.js";import{S as me,A as xe,a as te,g as ye}from"./version-map-Cjgc-yKJ.js";import{L as he}from"./loader-2-Bl4-IzP_.js";const we={class:"relative rounded-xl overflow-hidden shadow-sm hover:shadow-md transition-all duration-200 group cursor-pointer hover:-translate-y-1 h-full flex flex-col border border-white/20 bg-white"},_e={class:"absolute inset-0 z-0 overflow-hidden"},ke=["src"],Ce={class:"relative z-10 flex flex-col h-full"},Se={class:"relative aspect-[2/1] overflow-hidden m-3 rounded-lg shadow-sm"},$e=["src"],Me={class:"absolute bottom-0 left-0 bg-black/60 text-white px-1.5 py-0.5 text-[10px] font-mono rounded-tr-lg backdrop-blur-sm"},Ae={class:"px-3 pb-3 flex flex-col gap-1 flex-1"},je=["title"],Ve=["title"],Ne={class:"mt-auto pt-4 flex gap-1 justify-between items-end h-10"},Ue=["src"],De=["title"],ze={class:"text-[9px] font-black text-white leading-none shadow-black drop-shadow-md"},Re={__name:"MusicCard",props:{song:{type:Object,required:!0},userRecords:{type:Object,default:()=>({})}},setup(b){const w=b,_=V(()=>ne(w.song.id)),$=V(()=>w.song.type==="DX"?"bg-blue-500":"bg-yellow-500"),M=c=>!w.userRecords||!w.userRecords[c]?null:`/maiFCFS/${w.userRecords[c].rate.toLowerCase().replace("+","p")}.png`,m=c=>{c.target.src="/default_cover.jpg"};return(c,g)=>(o(),r("div",we,[s("div",_e,[s("img",{src:_.value,onError:m,class:"w-full h-full object-cover blur-xl scale-150 opacity-40"},null,40,ke),g[0]||(g[0]=s("div",{class:"absolute inset-0 bg-white/80 backdrop-blur-md"},null,-1))]),s("div",Ce,[s("div",Se,[s("img",{src:_.value,onError:m,loading:"lazy",class:"w-full h-full object-cover transition-transform duration-500 group-hover:scale-105",alt:"Cover"},null,40,$e),s("div",{class:B([$.value,"absolute top-0 right-0 px-2 py-0.5 text-xs font-black text-white rounded-bl-lg shadow-sm"])},d(b.song.type),3),s("div",Me," ID: "+d(b.song.id),1)]),s("div",Ae,[s("div",{class:"font-bold leading-tight line-clamp-2 text-gray-900 min-h-[2.5em]",title:b.song.title},d(b.song.title),9,je),s("div",{class:"text-xs text-gray-600 line-clamp-1",title:b.song.basic_info.artist},d(b.song.basic_info.artist),9,Ve),s("div",Ne,[(o(!0),r(y,null,h(b.song.level,(A,u)=>(o(),r("div",{key:u,class:"flex-1 flex flex-col items-center gap-0.5"},[M(u)?(o(),r("img",{key:0,src:M(u),class:"w-full object-contain drop-shadow-sm mb-0.5"},null,8,Ue)):O("",!0),s("div",{class:B(["w-full h-4 rounded flex items-center justify-center",u===0?"bg-maimai-green":u===1?"bg-maimai-yellow":u===2?"bg-maimai-red":u===3?"bg-maimai-purple":"bg-pink-300"]),title:A},[s("span",ze,d(b.song.ds[u]),1)],10,De)]))),128))])])])]))}},Le={class:"max-w-6xl mx-auto space-y-6 pb-12"},Oe={class:"flex flex-col md:flex-row items-start md:items-center justify-between gap-4"},Be={class:"text-3xl font-black flex items-center gap-2"},Ee={class:"text-gray-500 font-bold mt-1"},Fe={class:"bg-white border-2 border-black shadow-hard rounded-xl p-4 flex flex-col gap-4"},Ie={class:"relative w-full"},Pe={class:"space-y-3"},qe={class:"flex flex-col md:flex-row gap-2 relative"},Te={class:"flex-1 bg-gray-100 p-1 rounded-lg flex"},Xe=["onClick"],Ge={class:"flex gap-2"},He={key:0,class:"bg-gray-100 hover:bg-gray-200 border-2 border-transparent hover:border-gray-300 rounded-lg px-3 flex items-center justify-center gap-2 cursor-pointer select-none transition-all"},Qe={key:0,class:"absolute top-full right-0 mt-2 w-full md:w-[480px] bg-white rounded-xl shadow-xl border-2 border-gray-100 p-4 z-50"},Je={class:"flex justify-between items-center mb-4 border-b border-gray-100 pb-2"},Ke={class:"font-bold text-lg flex items-center gap-2"},We={class:"space-y-4"},Ye={class:"space-y-2"},Ze={class:"grid grid-cols-2 gap-2"},et=["value"],tt=["value"],st={class:"space-y-2"},lt={class:"flex gap-2"},at=["value"],ot={key:0,class:"space-y-2"},rt={class:"flex gap-2"},nt=["value"],it={class:"flex flex-wrap gap-2 mt-2"},ut=["value"],dt={class:"text-xs font-bold text-gray-600"},ct={key:0,class:"flex justify-center py-12"},vt={key:1},pt={class:"grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-6 gap-4"},bt={key:0,class:"flex justify-center mt-8 gap-2"},ft=["disabled"],gt={class:"flex items-center font-bold px-2"},mt=["disabled"],xt={key:2,class:"text-center py-12 text-gray-500 font-bold"},G=48,_t={__name:"MusicView",setup(b){const w=fe(),_=ie(),$=n([]),M=n(!0),m=n(""),c=n("all"),g=n("all"),A=n(!1),u=n(!1),N=n(""),U=n(""),E=n(-1),D=n(""),z=n(""),j=n(-1),k=n([]),H=n([]),Q=n([]),J=n(new Map),se=[{label:"默认 (ID)",value:"id"},{label:"达成率",value:"achievement"}],F=n("id"),I=n(!1),x=n(1),K=["Basic","Advanced","Expert","Master","Re:Master"],le=["SSS+","SSS","SS+","SS","S+","S","AAA","AA","A"],P=V(()=>{const l=new Map;return _.records&&_.records.forEach(e=>{const t=Number(e.song_id);l.has(t)||l.set(t,{}),l.get(t)[e.level_index]=e}),l}),T=V(()=>{let l=[...$.value];if(m.value){const e=m.value.toLowerCase();l=l.filter(t=>{if(t.title.toLowerCase().includes(e)||String(t.id).includes(e))return!0;const a=J.value.get(Number(t.id));return!!(a&&a.some(i=>i.toLowerCase().includes(e))||t.basic_info.artist.toLowerCase().includes(e)||t.charts&&t.charts.some(i=>i.charter.toLowerCase().includes(e)))})}if(c.value!=="all"&&(l=l.filter(e=>e.basic_info.genre===c.value)),g.value!=="all"&&(l=l.filter(e=>e.basic_info.from===g.value)),A.value&&(l=l.filter(e=>P.value.has(Number(e.id)))),N.value!==""||U.value!==""){const e=N.value===""?0:Number(N.value),t=U.value===""?99:Number(U.value);l=l.filter(a=>{if(E.value===-1)return a.ds.some(i=>i>=e&&i<=t);{const i=a.ds[E.value];return i!==void 0&&i>=e&&i<=t}})}if(D.value!==""||z.value!==""||k.value.length>0){const e=D.value===""?0:Number(D.value),t=z.value===""?101:Number(z.value);l=l.filter(a=>{const i=P.value.get(Number(a.id));if(!i)return!1;if(j.value===-1)return Object.values(i).some(v=>{const R=v.achievements>=e&&v.achievements<=t,C=k.value.length===0||k.value.includes(v.rate.toUpperCase().replace("P","+"));return R&&C});{const v=i[j.value];if(!v)return!1;const R=v.achievements>=e&&v.achievements<=t,C=k.value.length===0||k.value.includes(v.rate.toUpperCase().replace("P","+"));return R&&C}})}return l.sort((e,t)=>{let a,i;if(F.value==="id")a=Number(e.id),i=Number(t.id);else if(F.value==="achievement"){const v=R=>{var Y;const C=P.value.get(Number(R));return C?j.value!==-1?((Y=C[j.value])==null?void 0:Y.achievements)||-1:Math.max(...Object.values(C).map(re=>re.achievements)):-1};a=v(e.id),i=v(t.id)}return I.value?i-a:a-i}),l}),X=V(()=>Math.ceil(T.value.length/G)),ae=V(()=>{const l=(x.value-1)*G;return T.value.slice(l,l+G)}),W=l=>{x.value=l,window.scrollTo({top:0,behavior:"smooth"})},oe=l=>{w.push(`/song/${l.id}`)};return ue(async()=>{M.value=!0;try{$.value=await de();const l=new Set,e=new Set;$.value.forEach(t=>{t.basic_info.genre&&l.add(t.basic_info.genre),t.basic_info.from&&e.add(t.basic_info.from)}),H.value=Array.from(l).sort(),Q.value=Array.from(e).sort(),J.value=await ce()}catch(l){console.error("Failed to load metadata",l)}finally{M.value=!1}}),ve([m,c,g],()=>{x.value=1}),(l,e)=>(o(),r("div",Le,[s("div",Oe,[s("div",null,[s("h1",Be,[S(f(pe),{class:"text-maimai-blue",size:32}),e[16]||(e[16]=Z(" 乐曲查询 ",-1))]),s("p",Ee," 收录曲目: "+d($.value.length)+" 首 ",1)])]),s("div",Fe,[s("div",Ie,[S(f(me),{class:"absolute left-3 top-1/2 -translate-y-1/2 text-gray-400",size:18}),p(s("input",{"onUpdate:modelValue":e[0]||(e[0]=t=>m.value=t),type:"text",placeholder:"搜索曲名、别名、曲师、谱师、ID...",class:"input-base w-full pl-10"},null,512),[[L,m.value]])]),s("div",Pe,[s("div",qe,[s("div",Te,[(o(),r(y,null,h(se,t=>s("button",{key:t.value,onClick:a=>F.value=t.value,class:B(["flex-1 px-3 py-1.5 text-sm font-bold rounded-md transition-all whitespace-nowrap",F.value===t.value?"bg-white shadow-sm text-black ring-1 ring-black/5":"text-gray-500 hover:text-gray-700 hover:bg-gray-200/50"])},d(t.label),11,Xe)),64))]),s("div",Ge,[s("button",{onClick:e[1]||(e[1]=t=>I.value=!I.value),class:"bg-gray-100 hover:bg-gray-200 border-2 border-transparent hover:border-gray-300 rounded-lg px-3 flex items-center justify-center transition-all",title:"切换排序顺序"},[S(f(xe),{size:20,class:B([{"rotate-180":!I.value},"transition-transform text-gray-600"])},null,8,["class"])]),f(_).isAuthenticated?(o(),r("label",He,[p(s("input",{type:"checkbox","onUpdate:modelValue":e[2]||(e[2]=t=>A.value=t),class:"w-4 h-4 rounded border-gray-400 text-maimai-blue focus:ring-maimai-blue"},null,512),[[ee,A.value]]),e[17]||(e[17]=s("span",{class:"text-sm font-bold text-gray-700 whitespace-nowrap"},"只看已玩",-1))])):O("",!0),s("button",{onClick:e[3]||(e[3]=t=>u.value=!u.value),class:B(["bg-gray-100 hover:bg-gray-200 border-2 border-transparent hover:border-gray-300 rounded-lg px-3 flex items-center justify-center transition-all",u.value?"bg-gray-200 border-gray-300":""]),title:"高级筛选"},[S(f(te),{size:20,class:"text-gray-600"})],2)]),u.value?(o(),r("div",Qe,[s("div",Je,[s("h3",Ke,[S(f(te),{size:20}),e[18]||(e[18]=Z(" 高级筛选 ",-1))]),s("button",{onClick:e[4]||(e[4]=t=>u.value=!1),class:"p-1 hover:bg-gray-100 rounded-full transition-colors"},[S(f(be),{size:20,class:"text-gray-500"})])]),s("div",We,[s("div",Ye,[e[21]||(e[21]=s("div",{class:"text-xs font-bold text-gray-500 uppercase tracking-wider"},"基础筛选",-1)),s("div",Ze,[p(s("select",{"onUpdate:modelValue":e[5]||(e[5]=t=>c.value=t),class:"input-base w-full text-sm"},[e[19]||(e[19]=s("option",{value:"all"},"所有流派",-1)),(o(!0),r(y,null,h(H.value,t=>(o(),r("option",{key:t,value:t},d(t),9,et))),128))],512),[[q,c.value]]),p(s("select",{"onUpdate:modelValue":e[6]||(e[6]=t=>g.value=t),class:"input-base w-full text-sm"},[e[20]||(e[20]=s("option",{value:"all"},"所有版本",-1)),(o(!0),r(y,null,h(Q.value,t=>(o(),r("option",{key:t,value:t},d(f(ye)(t)),9,tt))),128))],512),[[q,g.value]])])]),s("div",st,[e[24]||(e[24]=s("div",{class:"text-xs font-bold text-gray-500 uppercase tracking-wider"},"定数筛选",-1)),s("div",lt,[p(s("select",{"onUpdate:modelValue":e[7]||(e[7]=t=>E.value=t),class:"input-base w-24 text-sm px-2"},[e[22]||(e[22]=s("option",{value:-1},"任意难度",-1)),(o(),r(y,null,h(K,(t,a)=>s("option",{key:a,value:a},d(t),9,at)),64))],512),[[q,E.value]]),p(s("input",{"onUpdate:modelValue":e[8]||(e[8]=t=>N.value=t),type:"number",placeholder:"Min",class:"input-base w-full text-sm",step:"0.1"},null,512),[[L,N.value]]),e[23]||(e[23]=s("span",{class:"self-center font-bold text-gray-400"},"-",-1)),p(s("input",{"onUpdate:modelValue":e[9]||(e[9]=t=>U.value=t),type:"number",placeholder:"Max",class:"input-base w-full text-sm",step:"0.1"},null,512),[[L,U.value]])])]),f(_).isAuthenticated?(o(),r("div",ot,[e[27]||(e[27]=s("div",{class:"text-xs font-bold text-gray-500 uppercase tracking-wider"},"达成率筛选",-1)),s("div",rt,[p(s("select",{"onUpdate:modelValue":e[10]||(e[10]=t=>j.value=t),class:"input-base w-24 text-sm px-2"},[e[25]||(e[25]=s("option",{value:-1},"任意难度",-1)),(o(),r(y,null,h(K,(t,a)=>s("option",{key:a,value:a},d(t),9,nt)),64))],512),[[q,j.value]]),p(s("input",{"onUpdate:modelValue":e[11]||(e[11]=t=>D.value=t),type:"number",placeholder:"Min %",class:"input-base w-full text-sm",step:"0.1"},null,512),[[L,D.value]]),e[26]||(e[26]=s("span",{class:"self-center font-bold text-gray-400"},"-",-1)),p(s("input",{"onUpdate:modelValue":e[12]||(e[12]=t=>z.value=t),type:"number",placeholder:"Max %",class:"input-base w-full text-sm",step:"0.1"},null,512),[[L,z.value]])]),s("div",it,[(o(),r(y,null,h(le,t=>s("label",{key:t,class:"flex items-center gap-1 cursor-pointer select-none bg-gray-50 px-2 py-1 rounded border border-gray-200 hover:bg-gray-100"},[p(s("input",{type:"checkbox",value:t,"onUpdate:modelValue":e[13]||(e[13]=a=>k.value=a),class:"w-3 h-3 rounded border-gray-400 text-maimai-blue focus:ring-maimai-blue"},null,8,ut),[[ee,k.value]]),s("span",dt,d(t),1)])),64))])])):O("",!0)])])):O("",!0)])])]),M.value?(o(),r("div",ct,[S(f(he),{class:"animate-spin text-maimai-blue",size:48})])):T.value.length>0?(o(),r("div",vt,[s("div",pt,[(o(!0),r(y,null,h(ae.value,t=>(o(),ge(Re,{key:t.id,song:t,"user-records":P.value.get(Number(t.id)),onClick:a=>oe(t)},null,8,["song","user-records","onClick"]))),128))]),X.value>1?(o(),r("div",bt,[s("button",{onClick:e[14]||(e[14]=t=>W(x.value-1)),disabled:x.value===1,class:"btn-base px-3 py-1 bg-white border-2 border-black disabled:opacity-50"}," 上一页 ",8,ft),s("span",gt,d(x.value)+" / "+d(X.value),1),s("button",{onClick:e[15]||(e[15]=t=>W(x.value+1)),disabled:x.value===X.value,class:"btn-base px-3 py-1 bg-white border-2 border-black disabled:opacity-50"}," 下一页 ",8,mt)])):O("",!0)])):(o(),r("div",xt," 没有找到符合条件的乐曲 "))]))}};export{_t as default};
