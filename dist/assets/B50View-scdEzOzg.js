import{b as a,k as E,d as n,o as l,e,j as k,n as S,t as x,F as R,i as $,u as M,a as F,r as W,l as X,x as q,h as _,D as O,f as T,g as G,S as Y,y as N,T as H}from"./index-DsRqQnq0.js";import{c as J,g as K}from"./rating-C4v8Mptf.js";import{D as Q,t as Z}from"./index-CPLoEXxT.js";import{A as ee}from"./arrow-left-XWTJjjcR.js";import{L as te}from"./loader-2-DvoeObHy.js";const se={class:"relative bg-white border-2 border-black flex flex-col select-none h-full shadow-[4px_4px_0px_0px_#000000] hover:translate-x-[2px] hover:translate-y-[2px] hover:shadow-[2px_2px_0px_0px_#000000] transition-all"},re={class:"relative z-10 flex flex-col h-full"},le={class:"relative aspect-[1.7/1] overflow-hidden border-b-2 border-black"},oe=["src"],ae={key:0,class:"absolute top-0 left-0 bg-black text-white px-1.5 py-0.5 text-[10px] font-bold border-r-2 border-b-2 border-white"},ne={class:"absolute bottom-0 left-0 flex items-stretch"},ie={class:"bg-black text-white px-2 py-0.5 text-xs font-bold border-t-2 border-r-2 border-white ml-[-2px] pl-3 flex items-center"},ce={class:"p-2 flex flex-col gap-1 flex-1 justify-between bg-white"},de=["title"],xe={class:"flex items-end justify-between mt-1"},ue={class:"flex items-center gap-0.5 h-4 md:h-5"},pe=["src"],be=["src"],me=["src"],B={__name:"B50SongCard",props:{record:{type:Object,required:!0},rank:{type:Number,default:0},customCoverUrl:{type:String,default:""}},setup(p){const o=p,u=a(()=>["bg-maimai-green","bg-maimai-yellow","bg-maimai-red","bg-maimai-purple","bg-pink-300"][o.record.level_index]||"bg-gray-400");a(()=>"text-white");const h=a(()=>{if(o.customCoverUrl)return o.customCoverUrl;const c=E(o.record.song_id);try{return new URL(c,window.location.origin).href}catch{return c}}),b=a(()=>o.record.achievements.toFixed(4)+"%"),m=a(()=>{const c=o.record.rate.toLowerCase();return c.startsWith("ss")?"text-[#FFD700]":c.startsWith("s")?"text-[#FF4500]":"text-blue-500"}),i=a(()=>o.record.type==="DX"?"bg-blue-500":"bg-yellow-500"),v=a(()=>`/maiFCFS/${o.record.rate.toLowerCase().replace("+","p")}.png`),g=a(()=>o.record.fc?`/maiFCFS/${o.record.fc}.png`:null),C=a(()=>o.record.fs?`/maiFCFS/${o.record.fs}.png`:null),w=c=>{c.target.src="/default_cover.jpg"};return(c,y)=>(l(),n("div",se,[e("div",re,[e("div",le,[e("img",{src:h.value,onError:w,class:"w-full h-full object-cover"},null,40,oe),e("div",{class:S([i.value,"absolute top-0 right-0 px-1.5 py-0.5 text-[10px] font-black text-white border-l-2 border-b-2 border-black"])},x(p.record.type),3),p.rank>0?(l(),n("div",ae," #"+x(p.rank),1)):k("",!0),e("div",ne,[e("div",{class:S([u.value,"relative z-10 px-2 py-0.5 text-white text-xs font-black border-t-2 border-r-2 border-black flex items-center justify-center min-w-[2rem]"])},x(p.record.level),3),e("div",ie,x(p.record.ra),1)])]),e("div",ce,[e("div",{class:"text-[10px] font-bold leading-tight line-clamp-1 text-black",title:p.record.title},x(p.record.title),9,de),e("div",xe,[e("span",{class:S([m.value,"text-sm md:text-lg font-black italic tracking-tighter"])},x(b.value),3),e("div",ue,[e("img",{src:v.value,class:"h-full object-contain"},null,8,pe),g.value?(l(),n("img",{key:0,src:g.value,class:"h-full object-contain"},null,8,be)):k("",!0),C.value?(l(),n("img",{key:1,src:C.value,class:"h-full object-contain"},null,8,me)):k("",!0)])])])])]))}},fe={class:"w-full overflow-hidden rounded-lg border-2 border-blue-500 bg-white text-sm"},ve={class:"grid grid-cols-6 bg-blue-50 text-center font-black text-blue-600"},_e={class:"py-1 border-r border-blue-200 bg-blue-600 text-white"},he={__name:"RatingTable",props:{dsList:{type:Array,default:()=>[10,10.5,11,11.5,12,12.5,13,13.5,14,14.5,15]}},setup(p){const o=p,u=[{label:"S+",ach:98,icon:"S+"},{label:"SS",ach:99,icon:"SS"},{label:"SS+",ach:99.5,icon:"SS+"},{label:"SSS",ach:100,icon:"SSS"},{label:"SSS+",ach:100.5,icon:"SSS+"}],h=a(()=>o.dsList.map(b=>{const m={ds:b.toFixed(1)};return u.forEach(i=>{m[i.label]=J(b,i.ach)}),m}));return(b,m)=>(l(),n("div",fe,[e("div",ve,[m[0]||(m[0]=e("div",{class:"py-1 border-r border-blue-200 bg-blue-600 text-white flex items-center justify-center"}," RATING ",-1)),(l(),n(R,null,$(u,i=>e("div",{key:i.label,class:"py-1 border-r border-blue-200 last:border-r-0 relative"},[e("span",{class:S(["drop-shadow-sm",{"text-orange-500":i.label.startsWith("S+"),"text-yellow-500":i.label.startsWith("SS"),"text-red-500":i.label.startsWith("SSS")}])},x(i.label),3)])),64))]),(l(!0),n(R,null,$(h.value,(i,v)=>(l(),n("div",{key:i.ds,class:S(["grid grid-cols-6 text-center font-bold text-gray-700 border-t border-blue-200",v%2===0?"bg-blue-50/30":"bg-white"])},[e("div",_e,x(i.ds),1),(l(),n(R,null,$(u,g=>e("div",{key:g.label,class:"py-1 border-r border-blue-200 last:border-r-0"},x(i[g.label]),1)),64))],2))),128))]))}},ge={class:"max-w-6xl mx-auto pb-12 space-y-6"},we={class:"flex items-center justify-between px-4 md:px-0"},ke={class:"flex gap-4"},ye=["disabled"],Se={class:"flex flex-col md:flex-row items-center justify-between mb-8 gap-6 bg-[#FFFBEB] p-4 md:p-6 border-2 border-black shadow-[4px_4px_0px_0px_#000000] rounded-3xl"},Re={class:"flex flex-col md:flex-row items-center gap-4 md:gap-6 w-full md:w-auto"},$e={class:"w-20 h-20 md:w-24 md:h-24 bg-maimai-yellow border-2 border-black flex items-center justify-center shadow-[4px_4px_0px_0px_#000000] flex-shrink-0"},Ce={class:"flex flex-col items-center md:items-start w-full"},Fe={class:"text-2xl md:text-3xl font-black text-black uppercase tracking-tighter mb-2 text-center md:text-left truncate max-w-[240px] md:max-w-xs"},Te={class:"relative w-full max-w-[260px] md:max-w-[320px] select-none filter drop-shadow-md",style:{"aspect-ratio":"1430/308"}},Ne=["src"],je={class:"absolute top-0 bottom-0 flex",style:{left:"46.8%",width:"40.5%"}},Ae={class:"flex gap-3 md:gap-4 text-center w-full md:w-auto justify-center"},Ie={class:"bg-white px-4 md:px-5 py-2 md:py-3 border-2 border-black shadow-[4px_4px_0px_0px_#000000] rounded-xl flex-1 md:flex-none min-w-[100px]"},De={class:"text-xl md:text-2xl font-black text-black leading-none"},Ge={class:"bg-white px-4 md:px-5 py-2 md:py-3 border-2 border-black shadow-[4px_4px_0px_0px_#000000] rounded-xl flex-1 md:flex-none min-w-[100px]"},Le={class:"text-xl md:text-2xl font-black text-black leading-none"},Be={class:"space-y-10"},Ee={key:0},Ue={class:"flex items-center gap-3 mb-6"},Pe={class:"font-black text-black border-2 border-black px-2 py-0.5 bg-white shadow-[2px_2px_0px_0px_#000000]"},ze={class:"grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-3 md:gap-4"},Ve={key:1},Me={class:"flex items-center gap-3 mb-6"},We={class:"font-black text-black border-2 border-black px-2 py-0.5 bg-white shadow-[2px_2px_0px_0px_#000000]"},Xe={class:"grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-3 md:gap-4"},qe={class:"mt-12"},Oe={key:0,class:"text-center py-20 text-gray-500 font-bold"},Ze={__name:"B50View",setup(p){const o=O(),u=M(),h=F(null),b=F(!1),m=F(!1),i=F(!1),v=W({}),g=async()=>{if(confirm("确定要重新获取最新成绩吗？")){m.value=!0;try{await u.fetchProfile()}catch(s){alert("更新失败: "+s.message)}finally{m.value=!1}}},C=a(()=>(i.value,u.records.map(K))),w=a(()=>C.value.filter(s=>s.isNew).sort((s,t)=>t.ra-s.ra).slice(0,15)),c=a(()=>C.value.filter(s=>!s.isNew).sort((s,t)=>t.ra-s.ra).slice(0,35)),y=a(()=>[...w.value,...c.value].sort((s,t)=>t.ra-s.ra)),U=a(()=>{if(y.value.length===0)return[10,11,12,13,14];const t=y.value.reduce((d,f)=>d+f.ds,0)/y.value.length,r=Math.round(t*10)/10;return[(r-.6).toFixed(1),(r-.3).toFixed(1),r.toFixed(1),(r+.3).toFixed(1),(r+.6).toFixed(1)].map(Number)}),j=a(()=>w.value.reduce((s,t)=>s+t.ra,0)),A=a(()=>c.value.reduce((s,t)=>s+t.ra,0)),I=a(()=>j.value+A.value),L=s=>{o.push(`/song/${s.song_id}`)},P=async()=>{const s=[...w.value,...c.value].map(async t=>{if(v[t.song_id])return;const r=async d=>{const f=await fetch(d);if(!f.ok)throw new Error(`Failed to load ${d}`);return await f.blob()};try{let d;try{d=await r(E(t.song_id))}catch{d=await r("/default_cover.jpg")}return new Promise(f=>{const D=new FileReader;D.onloadend=()=>{v[t.song_id]=D.result,f()},D.readAsDataURL(d)})}catch(d){console.error("Failed to preload image for",t.song_id,d)}});await Promise.all(s)},z=async()=>{if(h.value){b.value=!0;try{await P(),await new Promise(r=>setTimeout(r,1e3));const s=await Z(h.value,{cacheBust:!1,pixelRatio:2,backgroundColor:"#f3f4f6",skipAutoScale:!0,fontEmbedCSS:""}),t=document.createElement("a");t.download=`maimai_b50_${u.profile.username||"user"}.png`,t.href=s,t.click()}catch(s){console.error("Export failed:",s),alert("图片生成失败，请重试")}finally{b.value=!1}}};X(async()=>{try{await q(),i.value=!0}catch(s){console.error("Failed to load music data",s)}u.isAuthenticated&&u.records.length===0&&await u.fetchProfile()});const V=s=>s>=15e3?"/maiRATING/11.png":s>=14500?"/maiRATING/10.png":s>=14e3?"/maiRATING/9.png":s>=13e3?"/maiRATING/8.png":s>=12e3?"/maiRATING/7.png":s>=1e4?"/maiRATING/6.png":s>=7e3?"/maiRATING/5.png":s>=4e3?"/maiRATING/4.png":s>=2e3?"/maiRATING/3.png":s>=1e3?"/maiRATING/2.png":"/maiRATING/1.png";return(s,t)=>(l(),n("div",ge,[e("div",we,[e("button",{onClick:t[0]||(t[0]=r=>_(o).back()),class:"flex items-center gap-1 text-gray-500 font-bold hover:text-black transition-colors"},[T(_(ee),{size:20}),t[2]||(t[2]=G(" 返回 ",-1))]),e("div",ke,[e("button",{onClick:t[1]||(t[1]=r=>_(o).push("/recommendation")),class:"flex items-center gap-2 px-4 py-2 text-sm font-bold bg-maimai-purple text-white border-2 border-black shadow-[4px_4px_0px_0px_#000000] hover:translate-x-[2px] hover:translate-y-[2px] hover:shadow-[2px_2px_0px_0px_#000000] active:translate-x-[4px] active:translate-y-[4px] active:shadow-none transition-all"},[T(_(Y),{size:18}),t[3]||(t[3]=G(" 推分建议 ",-1))]),e("button",{onClick:z,disabled:b.value,class:"flex items-center gap-2 px-4 py-2 text-sm font-bold bg-maimai-blue text-white border-2 border-black shadow-[4px_4px_0px_0px_#000000] hover:translate-x-[2px] hover:translate-y-[2px] hover:shadow-[2px_2px_0px_0px_#000000] active:translate-x-[4px] active:translate-y-[4px] active:shadow-none transition-all disabled:opacity-50 disabled:cursor-not-allowed"},[b.value?(l(),N(_(te),{key:0,class:"animate-spin",size:18})):(l(),N(_(Q),{key:1,size:18})),G(" "+x(b.value?"生成中...":"保存图片"),1)],8,ye)])]),e("div",{class:"text-right px-4 md:px-0"},[e("button",{onClick:g,class:"text-xs font-bold text-gray-400 underline hover:text-maimai-blue"}," 数据不准确？点击更新成绩 ")]),e("div",{ref_key:"exportRef",ref:h,class:"bg-white p-4 md:p-8 border-2 border-black shadow-[8px_8px_0px_0px_#000000]"},[e("div",Se,[e("div",Re,[e("div",$e,[T(_(H),{size:40,class:"text-black md:w-12 md:h-12","stroke-width":"2.5"})]),e("div",Ce,[e("h1",Fe,x(_(u).profile.nickname||"PLAYER"),1),e("div",Te,[e("img",{src:V(I.value),class:"w-full h-full object-contain block",alt:"DX Rating Plate"},null,8,Ne),e("div",je,[(l(!0),n(R,null,$(I.value.toString().padStart(5," ").split(""),(r,d)=>(l(),n("div",{key:d,class:"w-full h-full flex items-center justify-center"},[r!==" "?(l(),n("span",{key:0,class:S(["font-black text-white font-mono leading-none text-center",I.value>=1e4?"text-lg md:text-xl":"text-xl md:text-2xl"]),style:{"text-shadow":"1.5px 1.5px 0 #000"}},x(r),3)):k("",!0)]))),128))])])])]),e("div",Ae,[e("div",Ie,[t[4]||(t[4]=e("div",{class:"text-[10px] md:text-xs font-black text-blue-500 uppercase tracking-wider mb-1"},"Best 35",-1)),e("div",De,x(A.value),1)]),e("div",Ge,[t[5]||(t[5]=e("div",{class:"text-[10px] md:text-xs font-black text-yellow-500 uppercase tracking-wider mb-1"},"Best 15",-1)),e("div",Le,x(j.value),1)])])]),e("div",Be,[c.value.length>0?(l(),n("div",Ee,[e("div",Ue,[t[6]||(t[6]=e("div",{class:"bg-maimai-blue text-white px-4 py-1 font-black text-xl border-2 border-black shadow-[4px_4px_0px_0px_#000000] uppercase italic transform -skew-x-12"}," Past Versions ",-1)),t[7]||(t[7]=e("div",{class:"h-1 flex-1 bg-black"},null,-1)),e("span",Pe,"Total: "+x(A.value),1)]),e("div",ze,[(l(!0),n(R,null,$(c.value,(r,d)=>(l(),N(B,{key:r.song_id+"_"+r.level_index,record:r,rank:d+1,"custom-cover-url":v[r.song_id],class:"cursor-pointer",onClick:f=>L(r)},null,8,["record","rank","custom-cover-url","onClick"]))),128))])])):k("",!0),w.value.length>0?(l(),n("div",Ve,[e("div",Me,[t[8]||(t[8]=e("div",{class:"bg-maimai-yellow text-black px-4 py-1 font-black text-xl border-2 border-black shadow-[4px_4px_0px_0px_#000000] uppercase italic transform -skew-x-12"}," Current Version ",-1)),t[9]||(t[9]=e("div",{class:"h-1 flex-1 bg-black"},null,-1)),e("span",We,"Total: "+x(j.value),1)]),e("div",Xe,[(l(!0),n(R,null,$(w.value,(r,d)=>(l(),N(B,{key:r.song_id+"_"+r.level_index,record:r,rank:d+1,"custom-cover-url":v[r.song_id],class:"cursor-pointer",onClick:f=>L(r)},null,8,["record","rank","custom-cover-url","onClick"]))),128))])])):k("",!0)]),e("div",qe,[t[10]||(t[10]=e("div",{class:"flex items-center gap-3 mb-6"},[e("div",{class:"bg-black text-white px-4 py-1 font-black text-xl border-2 border-black shadow-[4px_4px_0px_0px_#000000] uppercase italic transform -skew-x-12"}," Score Recommendation "),e("div",{class:"h-1 flex-1 bg-black"})],-1)),T(he,{"ds-list":U.value},null,8,["ds-list"])]),t[11]||(t[11]=e("div",{class:"mt-12 flex justify-center"},[e("div",{class:"bg-black text-white px-4 py-1 text-xs font-bold uppercase tracking-widest border-2 border-black"}," Generated by Maimai Tools ")],-1))],512),y.value.length===0?(l(),n("div",Oe," 暂无数据 ")):k("",!0)]))}};export{Ze as default};
