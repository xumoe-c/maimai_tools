import{c as F,N as nt,u as X,a as p,b as z,d,o as l,e as a,n as D,t as x,f as M,h as v,j as J,l as rt,x as ot,I as it,D as lt,g as Z,F as K,i as H,y as W,z as ct,S as dt,k as gt}from"./index-DsRqQnq0.js";import{g as ut,c as N}from"./rating-C4v8Mptf.js";import{A as xt}from"./arrow-left-XWTJjjcR.js";import{L as ft}from"./loader-2-DvoeObHy.js";/**
 * @license lucide-vue-next v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const vt=F("ArrowRightIcon",[["path",{d:"M5 12h14",key:"1ays0h"}],["path",{d:"m12 5 7 7-7 7",key:"xquz4c"}]]);/**
 * @license lucide-vue-next v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const pt=F("CoffeeIcon",[["path",{d:"M17 8h1a4 4 0 1 1 0 8h-1",key:"jx4kbh"}],["path",{d:"M3 8h14v9a4 4 0 0 1-4 4H7a4 4 0 0 1-4-4Z",key:"1bxrl0"}],["line",{x1:"6",x2:"6",y1:"2",y2:"4",key:"1cr9l3"}],["line",{x1:"10",x2:"10",y1:"2",y2:"4",key:"170wym"}],["line",{x1:"14",x2:"14",y1:"2",y2:"4",key:"1c5f70"}]]);/**
 * @license lucide-vue-next v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const yt=F("TargetIcon",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["circle",{cx:"12",cy:"12",r:"6",key:"1vlfrh"}],["circle",{cx:"12",cy:"12",r:"2",key:"1c9p78"}]]);/**
 * @license lucide-vue-next v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ht=F("TrendingUpIcon",[["polyline",{points:"22 7 13.5 15.5 8.5 10.5 2 17",key:"126l90"}],["polyline",{points:"16 7 22 7 22 13",key:"kwv8wd"}]]);/**
 * @license lucide-vue-next v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const mt=F("ZapIcon",[["polygon",{points:"13 2 3 14 12 14 11 22 21 10 12 10 13 2",key:"45s27k"}]]),bt=nt("recommendation",()=>{X();const n=p({}),y=p(!1),g=p(null);return{chartStats:n,isLoading:y,error:g,fetchChartStats:async()=>{if(!(Object.keys(n.value).length>0)){y.value=!0,g.value=null;try{const e="/".endsWith("/")?"/":"//",i=await fetch(`${e}data/chart_stats.json`);if(!i.ok)throw new Error(`Failed to load chart stats: ${i.statusText}`);const c=await i.json();n.value=c.charts||c}catch(e){g.value=e.message,console.error(e)}finally{y.value=!1}}},getFitDiff:(e,i)=>{const c=n.value[e];return!c||!c[i]?null:c[i].fit_diff},getAvgAchievement:(e,i)=>{const c=n.value[e];return!c||!c[i]?null:c[i].avg}}}),kt={class:"group relative bg-white border-2 border-black p-2 md:p-3 flex items-center gap-2 md:gap-4 transition-all duration-100 active:translate-x-1 active:translate-y-1 active:shadow-none shadow-[4px_4px_0px_0px_#000000] hover:bg-yellow-50"},_t={class:"relative w-14 h-14 md:w-16 md:h-16 flex-shrink-0 border-2 border-black overflow-hidden bg-gray-200"},wt=["src"],St={class:"flex-1 min-w-0"},Rt={class:"flex items-center gap-2"},At={class:"font-bold text-black truncate text-sm md:text-base"},Ct={class:"mt-1 md:mt-2 flex items-center gap-2 md:gap-4 text-xs md:text-sm"},$t={key:0,class:"flex flex-col"},Dt={key:1,class:"flex flex-col"},Ft={class:"font-black font-mono text-gray-800 leading-none"},Lt={class:"flex flex-col"},jt={class:"text-[8px] md:text-[10px] font-bold text-gray-500 uppercase"},Nt={class:"font-black font-mono text-maimai-blue leading-none"},Mt={class:"flex flex-col items-end justify-center min-w-[60px] md:min-w-[80px] pl-2 border-l-2 border-gray-100"},Tt={class:"flex items-center gap-1 text-maimai-blue font-black text-lg md:text-xl leading-none"},zt={key:0,class:"text-[8px] md:text-[10px] text-gray-400 font-bold text-right leading-tight"},Ut={__name:"RecommendationCard",props:{song:{type:Object,required:!0},stats:{type:Object,required:!0},userRecord:{type:Object,default:null},strategy:{type:String,required:!0},targetRating:{type:Number,default:0},targetAch:{type:Number,default:0},predictedRating:{type:Number,default:0},coverUrl:{type:String,default:""}},setup(n){const y=n,g=z(()=>{switch(y.stats.level_index){case 0:return"bg-green-500";case 1:return"bg-yellow-500";case 2:return"bg-red-500";case 3:return"bg-purple-500";case 4:return"bg-violet-300";default:return"bg-gray-500"}}),u=z(()=>["BSC","ADV","EXP","MST","Re:M"][y.stats.level_index]||"UNK"),m=e=>e>=100.5||e>=100?"text-red-500":e>=99.5||e>=99?"text-yellow-600":e>=98||e>=97?"text-orange-500":"text-gray-600",S=e=>e>=100.5?"SSS+":e>=100?"SSS":e>=99.5?"SS+":e>=99?"SS":e>=98?"S+":e>=97?"S":e.toFixed(1)+"%";return(e,i)=>(l(),d("div",kt,[a("div",_t,[a("img",{src:n.coverUrl,class:"w-full h-full object-cover",loading:"lazy"},null,8,wt),a("div",{class:D(["absolute bottom-0 left-0 right-0 h-1.5 border-t-2 border-black",g.value])},null,2)]),a("div",St,[a("div",Rt,[a("span",{class:D(["text-[10px] md:text-xs font-black px-1.5 py-0.5 border border-black text-white shadow-[1px_1px_0px_0px_#000000] md:shadow-[2px_2px_0px_0px_#000000]",g.value])},x(u.value)+" "+x(n.stats.ds.toFixed(1)),3),a("h3",At,x(n.song.title),1)]),a("div",Ct,[n.userRecord?(l(),d("div",$t,[i[0]||(i[0]=a("span",{class:"text-[8px] md:text-[10px] font-bold text-gray-500 uppercase"},"Current",-1)),a("span",{class:D(["font-black font-mono leading-none",m(n.userRecord.achievements)])},x(n.userRecord.achievements.toFixed(4))+"% ",3)])):(l(),d("div",Dt,[i[1]||(i[1]=a("span",{class:"text-[8px] md:text-[10px] font-bold text-gray-500 uppercase"},"Avg",-1)),a("span",Ft,x(n.stats.avg?n.stats.avg.toFixed(2):"---")+"% ",1)])),M(v(vt),{size:14,class:"text-black flex-shrink-0","stroke-width":"3"}),a("div",Lt,[a("span",jt,x(n.strategy==="attack"?"Target":"Predict"),1),a("span",Nt,x(n.strategy==="attack"?S(n.targetAch):n.stats.avg?n.stats.avg.toFixed(2)+"%":"---"),1)])])]),a("div",Mt,[a("div",Tt,[M(v(ht),{size:16,"stroke-width":"3"}),a("span",null,"+"+x((n.strategy==="attack"?n.targetRating-n.userRecord.ra:n.predictedRating).toFixed(0)),1)]),i[2]||(i[2]=a("div",{class:"text-[8px] md:text-[10px] text-gray-400 font-bold mt-1 text-right leading-tight"}," RATING UP ",-1)),n.stats.fit_diff?(l(),d("div",zt," Fit: "+x(n.stats.fit_diff.toFixed(2)),1)):J("",!0)])]))}},Et={class:"max-w-6xl mx-auto pb-12 space-y-6 px-4 md:px-0"},Bt={class:"flex items-center justify-between"},Pt={key:0,class:"bg-red-50 border-2 border-red-500 p-4 text-red-600 font-bold shadow-[4px_4px_0px_0px_#EF4444]"},Vt={key:1,class:"flex flex-col items-center justify-center py-20 text-gray-500"},Gt={key:2,class:"space-y-6"},qt={class:"flex overflow-x-auto gap-3 pb-4 no-scrollbar"},Ot=["onClick"],It={class:"bg-white border-2 border-black p-4 md:p-6 shadow-[8px_8px_0px_0px_#000000] min-h-[400px]"},Zt={key:0,class:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"},Kt={key:1,class:"text-center text-gray-400 py-20"},Ht={key:0,class:"text-xs mt-1 text-gray-300"},Yt={__name:"RecommendationView",setup(n){const y=lt(),g=X(),u=bt(),m=p("score-attack"),S=p(!0),e=p([]),i=p([]),c=p([]),U=p([]),E=p([]);rt(async()=>{S.value=!0;try{g.isAuthenticated&&g.records.length===0&&await g.fetchProfile(),e.value=await ot(),await u.fetchChartStats(),Q()}catch(h){console.error(h)}finally{S.value=!1}});const Q=()=>{if(!g.records.length||!e.value.length)return;const h=g.records.map(ut),o=h.filter(t=>t.isNew).sort((t,s)=>s.ra-t.ra).slice(0,15),r=h.filter(t=>!t.isNew).sort((t,s)=>s.ra-t.ra).slice(0,35),L=o.length===15?o[14].ra:0,P=r.length===35?r[34].ra:0,tt=o.length?o.reduce((t,s)=>t+s.ds,0)/o.length:10,et=r.length?r.reduce((t,s)=>t+s.ds,0)/r.length:10,st=Math.max(...h.map(t=>t.ds),10),V=[];h.forEach(t=>{const s=t.achievements;let f=0;if(s>=96.5&&s<97?f=97:s>=98.5&&s<99?f=99:s>=99&&s<99.5?f=99.5:s>=99.5&&s<100?f=100:s>=100&&s<100.5&&(f=100.5),f>0){const A=u.getFitDiff(t.song_id,t.level_index)||t.ds,C=N(A,f),b=C-t.ra;if(b>0){const j=it(t.song_id);j&&V.push({song:j,stats:{ds:t.ds,fit_diff:A,level_index:t.level_index,avg:u.getAvgAchievement(t.song_id,t.level_index)},userRecord:t,targetRating:C,targetAch:f,gain:b,strategy:"attack"})}}}),i.value=V.sort((t,s)=>s.gain-t.gain).slice(0,50);const G=[],q=[],O=[],at=new Set(h.map(t=>`${t.song_id}_${t.level_index}`));e.value.forEach(t=>{const s=t.basic_info.is_new,f=s?L:P,A=s?tt:et;t.ds.forEach((C,b)=>{const j=`${t.id}_${b}`,T=at.has(j),k=u.getFitDiff(t.id,b)||C,R=u.getAvgAchievement(t.id,b),I={ds:C,fit_diff:k,level_index:b,avg:R};if(!T&&R&&k>=A-1.5&&k<=A+2.5){const _=N(k,R),w=_-f;if(w>0){const $={song:t,stats:I,predictedRating:_,gain:w,strategy:"gem"};s?G.push($):q.push($)}}if(R&&R>=98.5&&k>=10&&k<=st+1){let _=0;if(T){const w=h.find($=>$.song_id===t.id&&$.level_index===b);_=w?w.achievements:0}if(_<100.5){const w=N(k,100.5);O.push({song:t,stats:I,userRecord:T?{achievements:_,ra:N(k,_)}:null,predictedRating:w,gain:R,strategy:"easy"})}}})}),c.value=G.sort((t,s)=>s.gain-t.gain).slice(0,50),U.value=q.sort((t,s)=>s.gain-t.gain).slice(0,50),E.value=O.sort((t,s)=>s.stats.avg-t.stats.avg).slice(0,50)},B=z(()=>{switch(m.value){case"score-attack":return i.value;case"new-gem":return c.value;case"old-gem":return U.value;case"easy":return E.value;default:return[]}}),Y=[{id:"score-attack",label:"临门一脚",icon:yt,color:"text-red-500"},{id:"new-gem",label:"新曲挖掘",icon:dt,color:"text-yellow-500"},{id:"old-gem",label:"旧曲挖掘",icon:mt,color:"text-blue-500"},{id:"easy",label:"甜品推荐",icon:pt,color:"text-green-500"}];return(h,o)=>(l(),d("div",Et,[a("div",Bt,[a("button",{onClick:o[0]||(o[0]=r=>v(y).back()),class:"flex items-center gap-1 text-gray-500 font-bold hover:text-black transition-colors"},[M(v(xt),{size:20}),o[1]||(o[1]=Z(" 返回 ",-1))]),o[2]||(o[2]=a("h1",{class:"text-2xl font-black text-gray-800"},"推分建议",-1)),o[3]||(o[3]=a("div",{class:"w-20"},null,-1))]),v(u).error?(l(),d("div",Pt," 数据加载失败: "+x(v(u).error),1)):S.value||v(u).isLoading?(l(),d("div",Vt,[M(v(ft),{class:"animate-spin mb-2",size:32}),o[4]||(o[4]=a("p",null,"正在分析全服数据...",-1))])):(l(),d("div",Gt,[a("div",qt,[(l(),d(K,null,H(Y,r=>a("button",{key:r.id,onClick:L=>m.value=r.id,class:D(["flex items-center gap-2 px-6 py-3 font-black transition-all whitespace-nowrap border-2",m.value===r.id?"bg-white border-black shadow-[4px_4px_0px_0px_#000000] -translate-y-1":"bg-gray-100 border-transparent text-gray-400 hover:border-black hover:bg-white hover:text-black"])},[(l(),W(ct(r.icon),{size:18,class:D(m.value===r.id?r.color:"")},null,8,["class"])),Z(" "+x(r.label),1)],10,Ot)),64))]),a("div",It,[B.value.length>0?(l(),d("div",Zt,[(l(!0),d(K,null,H(B.value,(r,L)=>(l(),W(Ut,{key:L,song:r.song,stats:r.stats,"user-record":r.userRecord,strategy:r.strategy,"target-rating":r.targetRating,"target-ach":r.targetAch,"predicted-rating":r.predictedRating,"cover-url":v(gt)(r.song.id),onClick:P=>v(y).push(`/song/${r.song.id}`),class:"cursor-pointer"},null,8,["song","stats","user-record","strategy","target-rating","target-ach","predicted-rating","cover-url","onClick"]))),128))])):(l(),d("div",Kt,[o[5]||(o[5]=a("p",{class:"font-bold text-lg"},"暂无推荐",-1)),o[6]||(o[6]=a("p",{class:"text-sm mt-2"},"可能是数据不足或您太强了！",-1)),m.value!=="score-attack"?(l(),d("p",Ht," (挖掘功能需要加载 chart_stats.json 数据) ")):J("",!0)]))])]))]))}};export{Yt as default};
