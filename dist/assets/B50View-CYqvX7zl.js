import{b as a,k as z,d as u,o as c,e,j as y,n as S,t as d,u as P,a as R,r as M,l as N,h as _,C as V,f as B,g as U,y as D,T as W,F as E,i as L,D as q}from"./index-DDtBvkLk.js";import{D as G,t as O}from"./index-CTYz7VfE.js";import{A as Y}from"./arrow-left-C4kQWf-z.js";import{L as H}from"./loader-2-Bl4-IzP_.js";const J={class:"relative rounded-lg overflow-hidden shadow-sm border border-white/20 flex flex-col select-none h-full"},K={class:"absolute inset-0 z-0 overflow-hidden"},Q=["src"],Z={class:"relative z-10 flex flex-col h-full"},ee={class:"relative aspect-[1.7/1] overflow-hidden shadow-sm"},te=["src"],se={key:0,class:"absolute top-0 left-0 bg-black/60 text-white px-1.5 py-0.5 text-[10px] font-bold rounded-br-lg backdrop-blur-sm border-b border-r border-white/10"},oe={class:"absolute bottom-0 left-0 flex items-stretch"},re={class:"bg-black/80 text-white px-2 py-0.5 text-xs font-bold rounded-tr-lg ml-[-4px] pl-3 flex items-center shadow-sm backdrop-blur-sm border-t border-r border-white/10"},le={class:"p-1.5 flex flex-col gap-0.5 flex-1 justify-between bg-white/80 backdrop-blur-sm"},ae=["title"],ne={class:"flex items-end justify-between mt-1"},ie={class:"flex items-center gap-0.5 h-5"},ce=["src"],de=["src"],ue=["src"],T={__name:"B50SongCard",props:{record:{type:Object,required:!0},rank:{type:Number,default:0},customCoverUrl:{type:String,default:""}},setup(f){const n=f,p=a(()=>["bg-maimai-green","bg-maimai-yellow","bg-maimai-red","bg-maimai-purple","bg-pink-300"][n.record.level_index]||"bg-gray-400");a(()=>"text-white");const h=a(()=>{if(n.customCoverUrl)return n.customCoverUrl;const i=z(n.record.song_id);try{return new URL(i,window.location.origin).href}catch{return i}}),m=a(()=>n.record.achievements.toFixed(4)+"%"),v=a(()=>{const i=n.record.rate.toLowerCase();return i.startsWith("ss")?"text-[#FFD700]":i.startsWith("s")?"text-[#FF4500]":"text-blue-500"}),F=a(()=>n.record.type==="DX"?"bg-blue-500":"bg-yellow-500"),$=a(()=>`/maiFCFS/${n.record.rate.toLowerCase().replace("+","p")}.png`),b=a(()=>n.record.fc?`/maiFCFS/${n.record.fc}.png`:null),x=a(()=>n.record.fs?`/maiFCFS/${n.record.fs}.png`:null),C=i=>{i.target.src="/default_cover.jpg"};return(i,g)=>(c(),u("div",J,[e("div",K,[e("img",{src:h.value,onError:C,class:"w-full h-full object-cover blur-xl scale-150 opacity-40"},null,40,Q),g[0]||(g[0]=e("div",{class:"absolute inset-0 bg-white/80 backdrop-blur-md"},null,-1))]),e("div",Z,[e("div",ee,[e("img",{src:h.value,onError:C,class:"w-full h-full object-cover"},null,40,te),e("div",{class:S([F.value,"absolute top-0 right-0 px-1.5 py-0.5 text-[10px] font-black text-white rounded-bl-lg shadow-sm"])},d(f.record.type),3),f.rank>0?(c(),u("div",se," #"+d(f.rank),1)):y("",!0),e("div",oe,[e("div",{class:S([p.value,"relative z-10 px-2 py-0.5 text-white text-xs font-black rounded-tr-lg shadow-sm flex items-center justify-center min-w-[2rem]"])},d(f.record.level),3),e("div",re,d(f.record.ra),1)])]),e("div",le,[e("div",{class:"text-[10px] font-bold leading-tight line-clamp-1 text-gray-900",title:f.record.title},d(f.record.title),9,ae),e("div",ne,[e("span",{class:S([v.value,"text-lg font-black italic tracking-tighter"]),style:{"text-shadow":"1px 1px 0px white, -1px -1px 0px white, 1px -1px 0px white, -1px 1px 0px white, 0px 2px 4px rgba(0,0,0,0.2)"}},d(m.value),3),e("div",ie,[e("img",{src:$.value,class:"h-full object-contain drop-shadow-sm"},null,8,ce),b.value?(c(),u("img",{key:0,src:b.value,class:"h-full object-contain drop-shadow-sm"},null,8,de)):y("",!0),x.value?(c(),u("img",{key:1,src:x.value,class:"h-full object-contain drop-shadow-sm"},null,8,ue)):y("",!0)])])])])]))}},fe={class:"max-w-6xl mx-auto pb-12 space-y-6"},pe={class:"flex items-center justify-between px-4 md:px-0"},be=["disabled"],xe={class:"flex flex-col md:flex-row items-center justify-between mb-8 gap-6 bg-white p-6 rounded-xl shadow-sm border-2 border-black/5"},me={class:"flex items-center gap-4"},ge={class:"w-20 h-20 bg-gradient-to-br from-maimai-yellow to-orange-400 rounded-full border-4 border-white shadow-lg flex items-center justify-center"},he={class:"text-2xl font-black text-gray-800"},ve={class:"text-4xl font-black text-maimai-blue tracking-tighter mt-1"},we={class:"flex gap-4 md:gap-8 text-center"},_e={class:"bg-blue-50 px-4 py-2 rounded-lg border border-blue-100"},ye={class:"text-xl font-black text-blue-600"},ke={class:"bg-yellow-50 px-4 py-2 rounded-lg border border-yellow-100"},$e={class:"text-xl font-black text-yellow-600"},Ce={class:"space-y-8"},De={key:0},Fe={class:"flex items-center gap-2 mb-4 pb-2 border-b-2 border-blue-100"},Se={class:"text-sm font-bold text-blue-400 bg-blue-50 px-2 py-0.5 rounded-full"},je={class:"grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-2 md:gap-3"},Re={key:1},Be={class:"flex items-center gap-2 mb-4 pb-2 border-b-2 border-yellow-100"},Ue={class:"text-sm font-bold text-yellow-400 bg-yellow-50 px-2 py-0.5 rounded-full"},Ee={class:"grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-2 md:gap-3"},Le={key:0,class:"text-center py-20 text-gray-500 font-bold"},Ae={__name:"B50View",setup(f){const n=V(),p=P(),h=R(null),m=R(!1),v=M({}),F=s=>{let t=s.ds,o=s.type;if(!t||!o){const w=q(s.song_id);w&&(t||(t=w.ds[s.level_index]),o||(o=w.basic_info.from==="舞萌DX"||parseInt(w.id)>1e4?"DX":"SD"),!o&&w.type&&(o=w.type))}t||(t=0),o||(o="DX");const r=Math.min(100.5,s.achievements);let l=0;r>=100.5?l=22.4:r>=100?l=21.6:r>=99.5?l=21.1:r>=99?l=20.8:r>=98?l=20.3:r>=97?l=20:r>=94?l=16.8:r>=90?l=15.2:r>=80?l=13.6:l=0;const k=Math.floor(t*(r/100)*l);return{...s,ds:t,type:o,ra:k}},$=a(()=>p.records.map(F)),b=a(()=>$.value.filter(s=>s.type==="DX").sort((s,t)=>t.ra-s.ra).slice(0,15)),x=a(()=>$.value.filter(s=>s.type==="SD").sort((s,t)=>t.ra-s.ra).slice(0,35)),C=a(()=>[...b.value,...x.value].sort((s,t)=>t.ra-s.ra)),i=a(()=>b.value.reduce((s,t)=>s+t.ra,0)),g=a(()=>x.value.reduce((s,t)=>s+t.ra,0)),I=a(()=>i.value+g.value),j=s=>{n.push(`/song/${s.song_id}`)},X=async()=>{const s=[...b.value,...x.value].map(async t=>{if(v[t.song_id])return;const o=async r=>{const l=await fetch(r);if(!l.ok)throw new Error(`Failed to load ${r}`);return await l.blob()};try{let r;try{r=await o(z(t.song_id))}catch{r=await o("/default_cover.jpg")}return new Promise(l=>{const k=new FileReader;k.onloadend=()=>{v[t.song_id]=k.result,l()},k.readAsDataURL(r)})}catch(r){console.error("Failed to preload image for",t.song_id,r)}});await Promise.all(s)},A=async()=>{if(h.value){m.value=!0;try{await X(),await new Promise(o=>setTimeout(o,1e3));const s=await O(h.value,{cacheBust:!1,pixelRatio:2,backgroundColor:"#f3f4f6",skipAutoScale:!0,fontEmbedCSS:""}),t=document.createElement("a");t.download=`maimai_b50_${p.profile.username||"user"}.png`,t.href=s,t.click()}catch(s){console.error("Export failed:",s),alert("图片生成失败，请重试")}finally{m.value=!1}}};return N(async()=>{p.isAuthenticated&&p.records.length===0&&await p.fetchProfile()}),(s,t)=>(c(),u("div",fe,[e("div",pe,[e("button",{onClick:t[0]||(t[0]=o=>_(n).back()),class:"flex items-center gap-1 text-gray-500 font-bold hover:text-black transition-colors"},[B(_(Y),{size:20}),t[1]||(t[1]=U(" 返回 ",-1))]),e("button",{onClick:A,disabled:m.value,class:"btn-base bg-maimai-blue text-white flex items-center gap-2 px-4 py-2 text-sm"},[m.value?(c(),D(_(H),{key:0,class:"animate-spin",size:18})):(c(),D(_(G),{key:1,size:18})),U(" "+d(m.value?"生成中...":"保存图片"),1)],8,be)]),e("div",{ref_key:"exportRef",ref:h,class:"bg-gray-100 p-4 md:p-8 rounded-xl overflow-hidden"},[e("div",xe,[e("div",me,[e("div",ge,[B(_(W),{size:40,class:"text-white drop-shadow-md"})]),e("div",null,[e("h1",he,d(_(p).profile.nickname||"PLAYER"),1),e("div",ve,d(I.value),1)])]),e("div",we,[e("div",_e,[t[2]||(t[2]=e("div",{class:"text-xs font-bold text-blue-400 uppercase tracking-wider"},"Best 35 (SD)",-1)),e("div",ye,d(g.value),1)]),e("div",ke,[t[3]||(t[3]=e("div",{class:"text-xs font-bold text-yellow-500 uppercase tracking-wider"},"Best 15 (DX)",-1)),e("div",$e,d(i.value),1)])])]),e("div",Ce,[x.value.length>0?(c(),u("div",De,[e("div",Fe,[t[4]||(t[4]=e("h2",{class:"text-xl font-black text-blue-600 uppercase tracking-wider"},"Standard (Best 35)",-1)),e("span",Se,"Total: "+d(g.value),1)]),e("div",je,[(c(!0),u(E,null,L(x.value,(o,r)=>(c(),D(T,{key:o.song_id+"_"+o.level_index,record:o,rank:r+1,"custom-cover-url":v[o.song_id],class:"shadow-sm hover:shadow-md transition-shadow cursor-pointer",onClick:l=>j(o)},null,8,["record","rank","custom-cover-url","onClick"]))),128))])])):y("",!0),b.value.length>0?(c(),u("div",Re,[e("div",Be,[t[5]||(t[5]=e("h2",{class:"text-xl font-black text-yellow-600 uppercase tracking-wider"},"DX (Best 15)",-1)),e("span",Ue,"Total: "+d(i.value),1)]),e("div",Ee,[(c(!0),u(E,null,L(b.value,(o,r)=>(c(),D(T,{key:o.song_id+"_"+o.level_index,record:o,rank:r+1,"custom-cover-url":v[o.song_id],class:"shadow-sm hover:shadow-md transition-shadow cursor-pointer",onClick:l=>j(o)},null,8,["record","rank","custom-cover-url","onClick"]))),128))])])):y("",!0)]),t[6]||(t[6]=e("div",{class:"mt-8 text-center text-gray-400 text-xs font-bold uppercase tracking-widest opacity-50"}," Generated by Maimai Tools ",-1))],512),C.value.length===0?(c(),u("div",Le," 暂无数据 ")):y("",!0)]))}};export{Ae as default};
