import{b as j,k as ie,d as r,o,e as s,n as E,t as u,F as y,i as h,j as B,u as ue,a as n,l as de,x as ce,m as ve,C as pe,w as fe,f as S,g as ee,h as b,M as be,p,v as O,s as te,X as me,q as T,D as ge,y as xe}from"./index-DsRqQnq0.js";import{g as ye}from"./version-map-BNZS0BZM.js";import{S as he}from"./search-BwHWkbEW.js";import{A as we,S as se}from"./sliders-horizontal-aWRtsoGE.js";import{L as _e}from"./loader-2-DvoeObHy.js";const ke={class:"relative rounded-xl overflow-hidden shadow-sm hover:shadow-md transition-all duration-200 group cursor-pointer hover:-translate-y-1 h-full flex flex-col border border-white/20 bg-white"},Ce={class:"absolute inset-0 z-0 overflow-hidden"},Se=["src"],$e={class:"relative z-10 flex flex-col h-full"},Me={class:"relative aspect-[2/1] overflow-hidden m-3 rounded-lg shadow-sm"},Ae=["src"],je={class:"absolute bottom-0 left-0 bg-black/60 text-white px-1.5 py-0.5 text-[10px] font-mono rounded-tr-lg backdrop-blur-sm"},Ve={class:"px-3 pb-3 flex flex-col gap-1 flex-1"},Ne=["title"],Ue=["title"],De={class:"mt-auto pt-4 flex gap-1 justify-between items-end h-10"},ze=["src"],Re=["title"],Le={class:"text-[9px] font-black text-white leading-none shadow-black drop-shadow-md"},Oe={__name:"MusicCard",props:{song:{type:Object,required:!0},userRecords:{type:Object,default:()=>({})}},setup(f){const w=f,V=j(()=>ie(w.song.id)),$=j(()=>w.song.type==="DX"?"bg-blue-500":"bg-yellow-500"),_=c=>!w.userRecords||!w.userRecords[c]?null:`/maiFCFS/${w.userRecords[c].rate.toLowerCase().replace("+","p")}.png`,M=c=>{c.target.src="/default_cover.jpg"};return(c,m)=>(o(),r("div",ke,[s("div",Ce,[s("img",{src:V.value,onError:M,class:"w-full h-full object-cover blur-xl scale-150 opacity-40"},null,40,Se),m[0]||(m[0]=s("div",{class:"absolute inset-0 bg-white/80 backdrop-blur-md"},null,-1))]),s("div",$e,[s("div",Me,[s("img",{src:V.value,onError:M,loading:"lazy",class:"w-full h-full object-cover transition-transform duration-500 group-hover:scale-105",alt:"Cover"},null,40,Ae),s("div",{class:E([$.value,"absolute top-0 right-0 px-2 py-0.5 text-xs font-black text-white rounded-bl-lg shadow-sm"])},u(f.song.type),3),s("div",je," ID: "+u(f.song.id),1)]),s("div",Ve,[s("div",{class:"font-bold leading-tight line-clamp-2 text-gray-900 min-h-[2.5em]",title:f.song.title},u(f.song.title),9,Ne),s("div",{class:"text-xs text-gray-600 line-clamp-1",title:f.song.basic_info.artist},u(f.song.basic_info.artist),9,Ue),s("div",De,[(o(!0),r(y,null,h(f.song.level,(g,d)=>(o(),r("div",{key:d,class:"flex-1 flex flex-col items-center gap-0.5"},[_(d)?(o(),r("img",{key:0,src:_(d),class:"w-full object-contain drop-shadow-sm mb-0.5"},null,8,ze)):B("",!0),s("div",{class:E(["w-full h-4 rounded flex items-center justify-center",d===0?"bg-maimai-green":d===1?"bg-maimai-yellow":d===2?"bg-maimai-red":d===3?"bg-maimai-purple":"bg-pink-300"]),title:g},[s("span",Le,u(f.song.ds[d]),1)],10,Re)]))),128))])])])]))}},Be={class:"max-w-6xl mx-auto space-y-6 pb-12"},Ee={class:"flex flex-col md:flex-row items-start md:items-center justify-between gap-4"},Fe={class:"text-3xl font-black flex items-center gap-2"},Ie={class:"text-gray-500 font-bold mt-1"},Pe={class:"bg-white border-2 border-black shadow-hard rounded-xl p-4 flex flex-col gap-4"},qe={class:"relative w-full"},Te={class:"space-y-3"},Xe={class:"flex flex-col md:flex-row gap-2 relative"},Ge={class:"flex-1 bg-gray-100 p-1 rounded-lg flex"},He=["onClick"],Qe={class:"flex gap-2"},Je={key:0,class:"bg-gray-100 hover:bg-gray-200 border-2 border-transparent hover:border-gray-300 rounded-lg px-3 flex items-center justify-center gap-2 cursor-pointer select-none transition-all"},Ke={key:0,class:"absolute top-full right-0 mt-2 w-full md:w-[480px] bg-white rounded-xl shadow-xl border-2 border-gray-100 p-4 z-50"},We={class:"flex justify-between items-center mb-4 border-b border-gray-100 pb-2"},Ye={class:"font-bold text-lg flex items-center gap-2"},Ze={class:"space-y-4"},et={class:"space-y-2"},tt={class:"grid grid-cols-2 gap-2"},st=["value"],lt=["value"],at={class:"space-y-2"},ot={class:"flex gap-2"},rt=["value"],nt={key:0,class:"space-y-2"},it={class:"flex gap-2"},ut=["value"],dt={class:"flex flex-wrap gap-2 mt-2"},ct=["value"],vt={class:"text-xs font-bold text-gray-600"},pt={key:0,class:"flex justify-center py-12"},ft={key:1},bt={class:"grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-6 gap-4"},mt={key:0,class:"flex justify-center mt-8 gap-2"},gt=["disabled"],xt={class:"flex items-center font-bold px-2"},yt=["disabled"],ht={key:2,class:"text-center py-12 text-gray-500 font-bold"},H=48,$t={__name:"MusicView",setup(f){const w=ge(),V=pe(),$=ue(),_=n([]),M=n(!0),c=n(""),m=n("all"),g=n("all"),d=n(!1),N=n(!1),U=n(""),D=n(""),F=n(-1),z=n(""),R=n(""),A=n(-1),k=n([]),Q=n([]),J=n([]),K=n(new Map),le=[{label:"默认 (ID)",value:"id"},{label:"达成率",value:"achievement"}],I=n("id"),P=n(!1),x=n(1),W=["Basic","Advanced","Expert","Master","Re:Master"],ae=["SSS+","SSS","SS+","SS","S+","S","AAA","AA","A"],q=j(()=>{const l=new Map;return $.records&&$.records.forEach(e=>{const t=Number(e.song_id);l.has(t)||l.set(t,{}),l.get(t)[e.level_index]=e}),l}),X=j(()=>{let l=[..._.value];if(c.value){const e=c.value.toLowerCase();l=l.filter(t=>{if(t.title.toLowerCase().includes(e)||String(t.id).includes(e))return!0;const a=K.value.get(Number(t.id));return!!(a&&a.some(i=>i.toLowerCase().includes(e))||t.basic_info.artist.toLowerCase().includes(e)||t.charts&&t.charts.some(i=>i.charter.toLowerCase().includes(e)))})}if(m.value!=="all"&&(l=l.filter(e=>e.basic_info.genre===m.value)),g.value!=="all"&&(l=l.filter(e=>e.basic_info.from===g.value)),d.value&&(l=l.filter(e=>q.value.has(Number(e.id)))),U.value!==""||D.value!==""){const e=U.value===""?0:Number(U.value),t=D.value===""?99:Number(D.value);l=l.filter(a=>{if(F.value===-1)return a.ds.some(i=>i>=e&&i<=t);{const i=a.ds[F.value];return i!==void 0&&i>=e&&i<=t}})}if(z.value!==""||R.value!==""||k.value.length>0){const e=z.value===""?0:Number(z.value),t=R.value===""?101:Number(R.value);l=l.filter(a=>{const i=q.value.get(Number(a.id));if(!i)return!1;if(A.value===-1)return Object.values(i).some(v=>{const L=v.achievements>=e&&v.achievements<=t,C=k.value.length===0||k.value.includes(v.rate.toUpperCase().replace("P","+"));return L&&C});{const v=i[A.value];if(!v)return!1;const L=v.achievements>=e&&v.achievements<=t,C=k.value.length===0||k.value.includes(v.rate.toUpperCase().replace("P","+"));return L&&C}})}return l.sort((e,t)=>{let a,i;if(I.value==="id")a=Number(e.id),i=Number(t.id);else if(I.value==="achievement"){const v=L=>{var Z;const C=q.value.get(Number(L));return C?A.value!==-1?((Z=C[A.value])==null?void 0:Z.achievements)||-1:Math.max(...Object.values(C).map(ne=>ne.achievements)):-1};a=v(e.id),i=v(t.id)}return P.value?i-a:a-i}),l}),G=j(()=>Math.ceil(X.value.length/H)),oe=j(()=>{const l=(x.value-1)*H;return X.value.slice(l,l+H)}),Y=l=>{x.value=l,window.scrollTo({top:0,behavior:"smooth"})},re=l=>{w.push(`/song/${l.id}`)};return de(async()=>{M.value=!0;try{_.value=await ce();const l=new Set,e=new Set;_.value.forEach(t=>{t.basic_info.genre&&l.add(t.basic_info.genre),t.basic_info.from&&e.add(t.basic_info.from)}),Q.value=Array.from(l).sort(),J.value=Array.from(e).sort(),K.value=await ve(),V.query.version&&(g.value=V.query.version)}catch(l){console.error("Failed to load metadata",l)}finally{M.value=!1}}),fe([c,m,g],()=>{x.value=1}),(l,e)=>(o(),r("div",Be,[s("div",Ee,[s("div",null,[s("h1",Fe,[S(b(be),{class:"text-maimai-blue",size:32}),e[16]||(e[16]=ee(" 乐曲查询 ",-1))]),s("p",Ie," 收录曲目: "+u(_.value.length)+" 首 ",1)])]),s("div",Pe,[s("div",qe,[S(b(he),{class:"absolute left-3 top-1/2 -translate-y-1/2 text-gray-400",size:18}),p(s("input",{"onUpdate:modelValue":e[0]||(e[0]=t=>c.value=t),type:"text",placeholder:"搜索曲名、别名、曲师、谱师、ID...",class:"input-base w-full pl-10"},null,512),[[O,c.value]])]),s("div",Te,[s("div",Xe,[s("div",Ge,[(o(),r(y,null,h(le,t=>s("button",{key:t.value,onClick:a=>I.value=t.value,class:E(["flex-1 px-3 py-1.5 text-sm font-bold rounded-md transition-all whitespace-nowrap",I.value===t.value?"bg-white shadow-sm text-black ring-1 ring-black/5":"text-gray-500 hover:text-gray-700 hover:bg-gray-200/50"])},u(t.label),11,He)),64))]),s("div",Qe,[s("button",{onClick:e[1]||(e[1]=t=>P.value=!P.value),class:"bg-gray-100 hover:bg-gray-200 border-2 border-transparent hover:border-gray-300 rounded-lg px-3 flex items-center justify-center transition-all",title:"切换排序顺序"},[S(b(we),{size:20,class:E([{"rotate-180":!P.value},"transition-transform text-gray-600"])},null,8,["class"])]),b($).isAuthenticated?(o(),r("label",Je,[p(s("input",{type:"checkbox","onUpdate:modelValue":e[2]||(e[2]=t=>d.value=t),class:"w-4 h-4 rounded border-gray-400 text-maimai-blue focus:ring-maimai-blue"},null,512),[[te,d.value]]),e[17]||(e[17]=s("span",{class:"text-sm font-bold text-gray-700 whitespace-nowrap"},"只看已玩",-1))])):B("",!0),s("button",{onClick:e[3]||(e[3]=t=>N.value=!N.value),class:E(["bg-gray-100 hover:bg-gray-200 border-2 border-transparent hover:border-gray-300 rounded-lg px-3 flex items-center justify-center transition-all",N.value?"bg-gray-200 border-gray-300":""]),title:"高级筛选"},[S(b(se),{size:20,class:"text-gray-600"})],2)]),N.value?(o(),r("div",Ke,[s("div",We,[s("h3",Ye,[S(b(se),{size:20}),e[18]||(e[18]=ee(" 高级筛选 ",-1))]),s("button",{onClick:e[4]||(e[4]=t=>N.value=!1),class:"p-1 hover:bg-gray-100 rounded-full transition-colors"},[S(b(me),{size:20,class:"text-gray-500"})])]),s("div",Ze,[s("div",et,[e[21]||(e[21]=s("div",{class:"text-xs font-bold text-gray-500 uppercase tracking-wider"},"基础筛选",-1)),s("div",tt,[p(s("select",{"onUpdate:modelValue":e[5]||(e[5]=t=>m.value=t),class:"input-base w-full text-sm"},[e[19]||(e[19]=s("option",{value:"all"},"所有流派",-1)),(o(!0),r(y,null,h(Q.value,t=>(o(),r("option",{key:t,value:t},u(t),9,st))),128))],512),[[T,m.value]]),p(s("select",{"onUpdate:modelValue":e[6]||(e[6]=t=>g.value=t),class:"input-base w-full text-sm"},[e[20]||(e[20]=s("option",{value:"all"},"所有版本",-1)),(o(!0),r(y,null,h(J.value,t=>(o(),r("option",{key:t,value:t},u(b(ye)(t)),9,lt))),128))],512),[[T,g.value]])])]),s("div",at,[e[24]||(e[24]=s("div",{class:"text-xs font-bold text-gray-500 uppercase tracking-wider"},"定数筛选",-1)),s("div",ot,[p(s("select",{"onUpdate:modelValue":e[7]||(e[7]=t=>F.value=t),class:"input-base w-24 text-sm px-2"},[e[22]||(e[22]=s("option",{value:-1},"任意难度",-1)),(o(),r(y,null,h(W,(t,a)=>s("option",{key:a,value:a},u(t),9,rt)),64))],512),[[T,F.value]]),p(s("input",{"onUpdate:modelValue":e[8]||(e[8]=t=>U.value=t),type:"number",placeholder:"Min",class:"input-base w-full text-sm",step:"0.1"},null,512),[[O,U.value]]),e[23]||(e[23]=s("span",{class:"self-center font-bold text-gray-400"},"-",-1)),p(s("input",{"onUpdate:modelValue":e[9]||(e[9]=t=>D.value=t),type:"number",placeholder:"Max",class:"input-base w-full text-sm",step:"0.1"},null,512),[[O,D.value]])])]),b($).isAuthenticated?(o(),r("div",nt,[e[27]||(e[27]=s("div",{class:"text-xs font-bold text-gray-500 uppercase tracking-wider"},"达成率筛选",-1)),s("div",it,[p(s("select",{"onUpdate:modelValue":e[10]||(e[10]=t=>A.value=t),class:"input-base w-24 text-sm px-2"},[e[25]||(e[25]=s("option",{value:-1},"任意难度",-1)),(o(),r(y,null,h(W,(t,a)=>s("option",{key:a,value:a},u(t),9,ut)),64))],512),[[T,A.value]]),p(s("input",{"onUpdate:modelValue":e[11]||(e[11]=t=>z.value=t),type:"number",placeholder:"Min %",class:"input-base w-full text-sm",step:"0.1"},null,512),[[O,z.value]]),e[26]||(e[26]=s("span",{class:"self-center font-bold text-gray-400"},"-",-1)),p(s("input",{"onUpdate:modelValue":e[12]||(e[12]=t=>R.value=t),type:"number",placeholder:"Max %",class:"input-base w-full text-sm",step:"0.1"},null,512),[[O,R.value]])]),s("div",dt,[(o(),r(y,null,h(ae,t=>s("label",{key:t,class:"flex items-center gap-1 cursor-pointer select-none bg-gray-50 px-2 py-1 rounded border border-gray-200 hover:bg-gray-100"},[p(s("input",{type:"checkbox",value:t,"onUpdate:modelValue":e[13]||(e[13]=a=>k.value=a),class:"w-3 h-3 rounded border-gray-400 text-maimai-blue focus:ring-maimai-blue"},null,8,ct),[[te,k.value]]),s("span",vt,u(t),1)])),64))])])):B("",!0)])])):B("",!0)])])]),M.value?(o(),r("div",pt,[S(b(_e),{class:"animate-spin text-maimai-blue",size:48})])):X.value.length>0?(o(),r("div",ft,[s("div",bt,[(o(!0),r(y,null,h(oe.value,t=>(o(),xe(Oe,{key:t.id,song:t,"user-records":q.value.get(Number(t.id)),onClick:a=>re(t)},null,8,["song","user-records","onClick"]))),128))]),G.value>1?(o(),r("div",mt,[s("button",{onClick:e[14]||(e[14]=t=>Y(x.value-1)),disabled:x.value===1,class:"btn-base px-3 py-1 bg-white border-2 border-black disabled:opacity-50"}," 上一页 ",8,gt),s("span",xt,u(x.value)+" / "+u(G.value),1),s("button",{onClick:e[15]||(e[15]=t=>Y(x.value+1)),disabled:x.value===G.value,class:"btn-base px-3 py-1 bg-white border-2 border-black disabled:opacity-50"}," 下一页 ",8,yt)])):B("",!0)])):(o(),r("div",ht," 没有找到符合条件的乐曲 "))]))}};export{$t as default};
