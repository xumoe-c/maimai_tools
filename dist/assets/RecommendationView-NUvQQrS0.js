import{c as D,a as z,b as l,o as i,e as s,n as $,t as c,g as M,u as x,s as J,C as ae,r as k,y as ne,z as re,O as oe,A as ie,m as Z,F as K,l as H,f as X,h as le,S as ce,x as de}from"./index-BVpVXXB2.js";import{u as ge}from"./recommendation-C8Od98en.js";import{g as xe,c as N}from"./rating-aTCu6OCO.js";import{A as ue}from"./arrow-left-jOfwdKCj.js";import{L as fe}from"./loader-2-yR3RaBWB.js";/**
 * @license lucide-vue-next v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const pe=D("ArrowRightIcon",[["path",{d:"M5 12h14",key:"1ays0h"}],["path",{d:"m12 5 7 7-7 7",key:"xquz4c"}]]);/**
 * @license lucide-vue-next v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ye=D("CoffeeIcon",[["path",{d:"M17 8h1a4 4 0 1 1 0 8h-1",key:"jx4kbh"}],["path",{d:"M3 8h14v9a4 4 0 0 1-4 4H7a4 4 0 0 1-4-4Z",key:"1bxrl0"}],["line",{x1:"6",x2:"6",y1:"2",y2:"4",key:"1cr9l3"}],["line",{x1:"10",x2:"10",y1:"2",y2:"4",key:"170wym"}],["line",{x1:"14",x2:"14",y1:"2",y2:"4",key:"1c5f70"}]]);/**
 * @license lucide-vue-next v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const me=D("TargetIcon",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["circle",{cx:"12",cy:"12",r:"6",key:"1vlfrh"}],["circle",{cx:"12",cy:"12",r:"2",key:"1c9p78"}]]);/**
 * @license lucide-vue-next v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ve=D("TrendingUpIcon",[["polyline",{points:"22 7 13.5 15.5 8.5 10.5 2 17",key:"126l90"}],["polyline",{points:"16 7 22 7 22 13",key:"kwv8wd"}]]);/**
 * @license lucide-vue-next v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const be=D("ZapIcon",[["polygon",{points:"13 2 3 14 12 14 11 22 21 10 12 10 13 2",key:"45s27k"}]]),he={class:"group relative bg-white border-2 border-black p-2 md:p-3 flex items-center gap-2 md:gap-4 transition-all duration-100 active:translate-x-1 active:translate-y-1 active:shadow-none shadow-[4px_4px_0px_0px_#000000] hover:bg-yellow-50"},ke={class:"relative w-14 h-14 md:w-16 md:h-16 flex-shrink-0 border-2 border-black overflow-hidden bg-gray-200"},_e=["src"],we={class:"flex-1 min-w-0"},Re={class:"flex items-center gap-2"},Se={class:"font-bold text-black truncate text-sm md:text-base"},Ae={class:"mt-1 md:mt-2 flex items-center gap-2 md:gap-4 text-xs md:text-sm"},Ce={key:0,class:"flex flex-col"},$e={key:1,class:"flex flex-col"},De={class:"font-black font-mono text-gray-800 leading-none"},Fe={class:"flex flex-col"},Le={class:"text-[8px] md:text-[10px] font-bold text-gray-500 uppercase"},Ne={class:"font-black font-mono text-maimai-blue leading-none"},Me={class:"flex flex-col items-end justify-center min-w-[60px] md:min-w-[80px] pl-2 border-l-2 border-gray-100"},je={class:"flex items-center gap-1 text-maimai-blue font-black text-lg md:text-xl leading-none"},ze={key:0,class:"text-[8px] md:text-[10px] text-gray-400 font-bold text-right leading-tight"},Te={__name:"RecommendationCard",props:{song:{type:Object,required:!0},stats:{type:Object,required:!0},userRecord:{type:Object,default:null},strategy:{type:String,required:!0},targetRating:{type:Number,default:0},targetAch:{type:Number,default:0},predictedRating:{type:Number,default:0},coverUrl:{type:String,default:""}},setup(n){const w=n,p=z(()=>{switch(w.stats.level_index){case 0:return"bg-green-500";case 1:return"bg-yellow-500";case 2:return"bg-red-500";case 3:return"bg-purple-500";case 4:return"bg-violet-300";default:return"bg-gray-500"}}),d=z(()=>["BSC","ADV","EXP","MST","Re:M"][w.stats.level_index]||"UNK"),v=r=>r>=100.5||r>=100?"text-red-500":r>=99.5||r>=99?"text-yellow-600":r>=98||r>=97?"text-orange-500":"text-gray-600",R=r=>r>=100.5?"SSS+":r>=100?"SSS":r>=99.5?"SS+":r>=99?"SS":r>=98?"S+":r>=97?"S":r.toFixed(1)+"%";return(r,u)=>(i(),l("div",he,[s("div",ke,[s("img",{src:n.coverUrl,class:"w-full h-full object-cover",loading:"lazy"},null,8,_e),s("div",{class:$(["absolute bottom-0 left-0 right-0 h-1.5 border-t-2 border-black",p.value])},null,2)]),s("div",we,[s("div",Re,[s("span",{class:$(["text-[10px] md:text-xs font-black px-1.5 py-0.5 border border-black text-white shadow-[1px_1px_0px_0px_#000000] md:shadow-[2px_2px_0px_0px_#000000]",p.value])},c(d.value)+" "+c(n.stats.ds.toFixed(1)),3),s("h3",Se,c(n.song.title),1)]),s("div",Ae,[n.userRecord?(i(),l("div",Ce,[u[0]||(u[0]=s("span",{class:"text-[8px] md:text-[10px] font-bold text-gray-500 uppercase"},"Current",-1)),s("span",{class:$(["font-black font-mono leading-none",v(n.userRecord.achievements)])},c(n.userRecord.achievements.toFixed(4))+"% ",3)])):(i(),l("div",$e,[u[1]||(u[1]=s("span",{class:"text-[8px] md:text-[10px] font-bold text-gray-500 uppercase"},"Avg",-1)),s("span",De,c(n.stats.avg?n.stats.avg.toFixed(2):"---")+"% ",1)])),M(x(pe),{size:14,class:"text-black flex-shrink-0","stroke-width":"3"}),s("div",Fe,[s("span",Le,c(n.strategy==="attack"?"Target":"Predict"),1),s("span",Ne,c(n.strategy==="attack"?R(n.targetAch):n.stats.avg?n.stats.avg.toFixed(2)+"%":"---"),1)])])]),s("div",Me,[s("div",je,[M(x(ve),{size:16,"stroke-width":"3"}),s("span",null,"+"+c((n.strategy==="attack"?n.targetRating-n.userRecord.ra:n.predictedRating).toFixed(0)),1)]),u[2]||(u[2]=s("div",{class:"text-[8px] md:text-[10px] text-gray-400 font-bold mt-1 text-right leading-tight"}," RATING UP ",-1)),n.stats.fit_diff?(i(),l("div",ze," Fit: "+c(n.stats.fit_diff.toFixed(2)),1)):J("",!0)])]))}},Ue={class:"max-w-6xl mx-auto pb-12 space-y-6 px-4 md:px-0"},Be={class:"flex items-center justify-between"},Ee={key:0,class:"bg-red-50 border-2 border-red-500 p-4 text-red-600 font-bold shadow-[4px_4px_0px_0px_#EF4444]"},Pe={key:1,class:"flex flex-col items-center justify-center py-20 text-gray-500"},Ve={key:2,class:"space-y-6"},Ge={class:"flex overflow-x-auto gap-3 pb-4 no-scrollbar"},qe=["onClick"],Ie={class:"bg-white border-2 border-black p-4 md:p-6 shadow-[8px_8px_0px_0px_#000000] min-h-[400px]"},Oe={key:0,class:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"},Ze={key:1,class:"text-center text-gray-400 py-20"},Ke={key:0,class:"text-xs mt-1 text-gray-300"},Ye={__name:"RecommendationView",setup(n){const w=ie(),p=ae(),d=ge(),v=k("score-attack"),R=k(!0),r=k([]),u=k([]),T=k([]),U=k([]),B=k([]);ne(async()=>{R.value=!0;try{p.isAuthenticated&&p.records.length===0&&await p.fetchProfile(),r.value=await re(),await d.fetchChartStats(),Q()}catch(f){console.error(f)}finally{R.value=!1}});const Q=()=>{if(!p.records.length||!r.value.length)return;const f=p.records.map(xe),o=f.filter(e=>e.isNew).sort((e,t)=>t.ra-e.ra).slice(0,15),a=f.filter(e=>!e.isNew).sort((e,t)=>t.ra-e.ra).slice(0,35),F=o.length===15?o[14].ra:0,P=a.length===35?a[34].ra:0,Y=o.length?o.reduce((e,t)=>e+t.ds,0)/o.length:10,ee=a.length?a.reduce((e,t)=>e+t.ds,0)/a.length:10,te=Math.max(...f.map(e=>e.ds),10),V=[];f.forEach(e=>{const t=e.achievements;let g=0;if(t>=96.5&&t<97?g=97:t>=98.5&&t<99?g=99:t>=99&&t<99.5?g=99.5:t>=99.5&&t<100?g=100:t>=100&&t<100.5&&(g=100.5),g>0){const S=d.getFitDiff(e.song_id,e.level_index)||e.ds,A=N(S,g),y=A-e.ra;if(y>0){const L=oe(e.song_id);L&&V.push({song:L,stats:{ds:e.ds,fit_diff:S,level_index:e.level_index,avg:d.getAvgAchievement(e.song_id,e.level_index)},userRecord:e,targetRating:A,targetAch:g,gain:y,strategy:"attack"})}}}),u.value=V.sort((e,t)=>t.gain-e.gain).slice(0,50);const G=[],q=[],I=[],se=new Set(f.map(e=>`${e.song_id}_${e.level_index}`));r.value.forEach(e=>{const t=e.basic_info.is_new,g=t?F:P,S=t?Y:ee;e.ds.forEach((A,y)=>{const L=`${e.id}_${y}`,j=se.has(L),m=d.getFitDiff(e.id,y)||A,_=d.getAvgAchievement(e.id,y),O={ds:A,fit_diff:m,level_index:y,avg:_};if(!j&&_&&m>=S-1.5&&m<=S+2.5){const b=N(m,_),h=b-g;if(h>0){const C={song:e,stats:O,predictedRating:b,gain:h,strategy:"gem"};t?G.push(C):q.push(C)}}if(_&&_>=98.5&&m>=10&&m<=te+1){let b=0;if(j){const h=f.find(C=>C.song_id===e.id&&C.level_index===y);b=h?h.achievements:0}if(b<100.5){const h=N(m,100.5);I.push({song:e,stats:O,userRecord:j?{achievements:b,ra:N(m,b)}:null,predictedRating:h,gain:_,strategy:"easy"})}}})}),T.value=G.sort((e,t)=>t.gain-e.gain).slice(0,50),U.value=q.sort((e,t)=>t.gain-e.gain).slice(0,50),B.value=I.sort((e,t)=>t.stats.avg-e.stats.avg).slice(0,50)},E=z(()=>{switch(v.value){case"score-attack":return u.value;case"new-gem":return T.value;case"old-gem":return U.value;case"easy":return B.value;default:return[]}}),W=[{id:"score-attack",label:"临门一脚",icon:me,color:"text-red-500"},{id:"new-gem",label:"新曲挖掘",icon:ce,color:"text-yellow-500"},{id:"old-gem",label:"旧曲挖掘",icon:be,color:"text-blue-500"},{id:"easy",label:"甜品推荐",icon:ye,color:"text-green-500"}];return(f,o)=>(i(),l("div",Ue,[s("div",Be,[s("button",{onClick:o[0]||(o[0]=a=>x(w).back()),class:"flex items-center gap-1 text-gray-500 font-bold hover:text-black transition-colors"},[M(x(ue),{size:20}),o[1]||(o[1]=Z(" 返回 ",-1))]),o[2]||(o[2]=s("h1",{class:"text-2xl font-black text-gray-800"},"推分建议",-1)),o[3]||(o[3]=s("div",{class:"w-20"},null,-1))]),x(d).error?(i(),l("div",Ee," 数据加载失败: "+c(x(d).error),1)):R.value||x(d).isLoading?(i(),l("div",Pe,[M(x(fe),{class:"animate-spin mb-2",size:32}),o[4]||(o[4]=s("p",null,"正在分析全服数据...",-1))])):(i(),l("div",Ve,[s("div",Ge,[(i(),l(K,null,H(W,a=>s("button",{key:a.id,onClick:F=>v.value=a.id,class:$(["flex items-center gap-2 px-6 py-3 font-black transition-all whitespace-nowrap border-2",v.value===a.id?"bg-white border-black shadow-[4px_4px_0px_0px_#000000] -translate-y-1":"bg-gray-100 border-transparent text-gray-400 hover:border-black hover:bg-white hover:text-black"])},[(i(),X(le(a.icon),{size:18,class:$(v.value===a.id?a.color:"")},null,8,["class"])),Z(" "+c(a.label),1)],10,qe)),64))]),s("div",Ie,[E.value.length>0?(i(),l("div",Oe,[(i(!0),l(K,null,H(E.value,(a,F)=>(i(),X(Te,{key:F,song:a.song,stats:a.stats,"user-record":a.userRecord,strategy:a.strategy,"target-rating":a.targetRating,"target-ach":a.targetAch,"predicted-rating":a.predictedRating,"cover-url":x(de)(a.song.id),onClick:P=>x(w).push(`/song/${a.song.id}`),class:"cursor-pointer"},null,8,["song","stats","user-record","strategy","target-rating","target-ach","predicted-rating","cover-url","onClick"]))),128))])):(i(),l("div",Ze,[o[5]||(o[5]=s("p",{class:"font-bold text-lg"},"暂无推荐",-1)),o[6]||(o[6]=s("p",{class:"text-sm mt-2"},"可能是数据不足或您太强了！",-1)),v.value!=="score-attack"?(i(),l("p",Ke," (挖掘功能需要加载 chart_stats.json 数据) ")):J("",!0)]))])]))]))}};export{Ye as default};
